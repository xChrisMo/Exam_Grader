{% extends "base.html" %} {% block title %}Grading Results - Exam Grader{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">
    <i class="bi bi-award text-primary me-2"></i>
    Grading Results
  </h1>
  <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
    <i class="bi bi-arrow-left me-1"></i> Back to Home
  </a>
</div>

<!-- Score Overview -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Score Overview</h5>
  </div>
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-4 text-center mb-4 mb-md-0">
        <div
          class="score-circle mb-2 {% if result.percent_score is defined and result.percent_score >= 80 %}bg-success {% elif result.percent_score is defined and result.percent_score >= 60 %}bg-primary {% elif result.percent_score is defined and result.percent_score >= 40 %}bg-warning {% else %}bg-danger{% endif %}"
        >
          {{ result.percent_score|default(0)|round|int }}%
        </div>
        <h5>Overall Score</h5>
        <p class="text-muted mb-0">
          {{ result.overall_score|default(0) }} / {{
          result.max_possible_score|default(100) }} marks
        </p>
        {% if result.metadata.total_marks_available is defined and
        result.metadata.total_marks_available != result.max_possible_score %}
        <div class="mt-2 small text-warning">
          <i class="bi bi-info-circle"></i> Total marks available in guide: {{
          result.metadata.total_marks_available }}
        </div>
        {% endif %} {% if result.letter_grade is defined %}
        <div class="mt-2">
          <span class="badge bg-primary fs-5"
            >Grade: {{ result.letter_grade }}</span
          >
        </div>
        {% endif %}
      </div>
      <div class="col-md-8">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="p-3 bg-light rounded">
              <div class="d-flex justify-content-between">
                <h6 class="mb-0">Questions Graded</h6>
                <span class="badge bg-primary">
                  {{ result.metadata.total_questions|default(0) }}
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="p-3 bg-light rounded">
              <div class="d-flex justify-content-between">
                <h6 class="mb-0">Graded At</h6>
                <span class="badge bg-secondary">
                  {{ result.metadata.graded_at|format_date }}
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="p-3 bg-light rounded">
              <div class="d-flex justify-content-between">
                <h6 class="mb-0">Grading Method</h6>
                <span class="badge bg-info">
                  {{ result.metadata.grading_method|default('Similarity') }}
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="p-3 bg-light rounded">
              <div class="d-flex justify-content-between">
                <h6 class="mb-0">Total Marks Available</h6>
                <span class="badge bg-success">
                  {{
                  result.metadata.total_marks_available|default(result.max_possible_score)
                  }}
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="p-3 bg-light rounded">
              <div class="d-flex justify-content-between">
                <h6 class="mb-0">Guide Type</h6>
                <span class="badge bg-secondary">
                  {{ result.metadata.guide_type|default('Unknown')|title }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Detailed Feedback -->
{% if result.detailed_feedback is defined %}
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Detailed Feedback</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-12">
        {% if result.detailed_feedback.strengths %}
        <h5 class="text-success">
          <i class="bi bi-check-circle me-2"></i>Strengths
        </h5>
        <ul class="list-group mb-4">
          {% for strength in result.detailed_feedback.strengths %}
          <li class="list-group-item">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            {{ strength }}
          </li>
          {% endfor %}
        </ul>
        {% endif %} {% if result.detailed_feedback.weaknesses %}
        <h5 class="text-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>Areas to Improve
        </h5>
        <ul class="list-group mb-4">
          {% for weakness in result.detailed_feedback.weaknesses %}
          <li class="list-group-item">
            <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
            {{ weakness }}
          </li>
          {% endfor %}
        </ul>
        {% endif %} {% if result.detailed_feedback.improvement_suggestions %}
        <h5 class="text-info">
          <i class="bi bi-lightbulb me-2"></i>Suggestions for Improvement
        </h5>
        <ul class="list-group mb-4">
          {% for suggestion in result.detailed_feedback.improvement_suggestions
          %}
          <li class="list-group-item">
            <i class="bi bi-lightbulb-fill text-info me-2"></i>
            {{ suggestion }}
          </li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% elif result.strengths is defined or result.weaknesses is defined %}
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Detailed Feedback</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-12">
        {% if result.strengths %}
        <h5 class="text-success">
          <i class="bi bi-check-circle me-2"></i>Strengths
        </h5>
        <ul class="list-group mb-4">
          {% for strength in result.strengths %}
          <li class="list-group-item">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            {{ strength }}
          </li>
          {% endfor %}
        </ul>
        {% endif %} {% if result.weaknesses %}
        <h5 class="text-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>Areas to Improve
        </h5>
        <ul class="list-group mb-4">
          {% for weakness in result.weaknesses %}
          <li class="list-group-item">
            <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
            {{ weakness }}
          </li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Question Scores -->
{% if result.criteria_scores is defined and result.criteria_scores %}
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Question Scores</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Question</th>
            <th class="text-center">Score</th>
            <th class="text-center">Max</th>
            <th class="text-center">Match %</th>
            <th class="text-center">Details</th>
          </tr>
        </thead>
        <tbody>
          {% for criteria in result.criteria_scores %}
          <tr>
            <td>
              {{ criteria.description }} {% if criteria.feedback %}
              <small class="d-block text-muted mt-1"
                >{{ criteria.feedback }}</small
              >
              {% endif %}
            </td>
            <td class="text-center">{{ criteria.points_earned|default(0) }}</td>
            <td class="text-center">
              {{ criteria.points_possible|default(0) }}
            </td>
            <td>
              {% if criteria.similarity is defined %}
              <div class="progress" style="height: 20px">
                {% set score = (criteria.similarity * 100)|int %}
                <div
                  class="progress-bar {% if score >= 80 %}bg-success {% elif score >= 60 %}bg-info {% elif score >= 40 %}bg-warning {% else %}bg-danger{% endif %}"
                  role="progressbar"
                  style="width: {{ score }}%;"
                  aria-valuenow="{{ score }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  {{ score }}%
                </div>
              </div>
              {% else %}
              <span class="badge bg-secondary">N/A</span>
              {% endif %}
            </td>
            <td class="text-center">
              <button
                class="btn btn-sm btn-outline-primary"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#details-{{ loop.index }}"
                aria-expanded="false"
              >
                <i class="bi bi-info-circle"></i> Details
              </button>
            </td>
          </tr>
          <tr class="collapse" id="details-{{ loop.index }}">
            <td colspan="5" class="bg-light">
              <div class="row">
                <div class="col-md-6">
                  <h6>Model Answer:</h6>
                  <div class="p-2 bg-white border rounded mb-3">
                    {{ criteria.guide_answer|nl2br }}
                  </div>

                  {% if criteria.detailed_feedback and
                  criteria.detailed_feedback.key_points %}
                  <div class="mb-3">
                    <h6>Key Points:</h6>
                    {% if criteria.detailed_feedback.key_points.matched %}
                    <div class="mb-2">
                      <strong class="text-success">Matched:</strong>
                      <ul class="mb-0 ps-3">
                        {% for point in
                        criteria.detailed_feedback.key_points.matched %}
                        <li>{{ point }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endif %} {% if
                    criteria.detailed_feedback.key_points.partially_matched %}
                    <div class="mb-2">
                      <strong class="text-warning">Partially Matched:</strong>
                      <ul class="mb-0 ps-3">
                        {% for point in
                        criteria.detailed_feedback.key_points.partially_matched
                        %}
                        <li>{{ point }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endif %} {% if
                    criteria.detailed_feedback.key_points.missed %}
                    <div>
                      <strong class="text-danger">Missed:</strong>
                      <ul class="mb-0 ps-3">
                        {% for point in
                        criteria.detailed_feedback.key_points.missed %}
                        <li>{{ point }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <h6>Student Answer:</h6>
                  <div class="p-2 bg-white border rounded">
                    {{ criteria.student_answer|nl2br }}
                  </div>

                  <div class="mt-3">
                    <h6>Grading Breakdown:</h6>
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Criteria</th>
                          <th>Score</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% if criteria.match_score is defined %}
                        <tr>
                          <td>Text Match Score</td>
                          <td>{{ (criteria.match_score * 100)|round|int }}%</td>
                        </tr>
                        {% endif %} {% if criteria.answer_score is defined %}
                        <tr>
                          <td>Answer Similarity</td>
                          <td>
                            {{ (criteria.answer_score * 100)|round|int }}%
                          </td>
                        </tr>
                        {% endif %} {% if criteria.keyword_score is defined %}
                        <tr>
                          <td>Keyword Match</td>
                          <td>
                            {{ (criteria.keyword_score * 100)|round|int }}%
                          </td>
                        </tr>
                        {% endif %} {% if criteria.match_reason %}
                        <tr>
                          <td colspan="2" class="text-muted small">
                            <strong>Match details:</strong> {{
                            criteria.match_reason }}
                          </td>
                        </tr>
                        {% endif %} {% if criteria.detailed_feedback and
                        criteria.detailed_feedback.breakdown %} {% if
                        criteria.detailed_feedback.breakdown.content_accuracy %}
                        <tr>
                          <td>Content Accuracy (40%)</td>
                          <td>
                            {{
                            criteria.detailed_feedback.breakdown.content_accuracy.score
                            }}/10
                          </td>
                        </tr>
                        {% endif %} {% if
                        criteria.detailed_feedback.breakdown.completeness %}
                        <tr>
                          <td>Completeness (30%)</td>
                          <td>
                            {{
                            criteria.detailed_feedback.breakdown.completeness.score
                            }}/10
                          </td>
                        </tr>
                        {% endif %} {% if
                        criteria.detailed_feedback.breakdown.understanding %}
                        <tr>
                          <td>Understanding (20%)</td>
                          <td>
                            {{
                            criteria.detailed_feedback.breakdown.understanding.score
                            }}/10
                          </td>
                        </tr>
                        {% endif %} {% if
                        criteria.detailed_feedback.breakdown.clarity %}
                        <tr>
                          <td>Clarity (10%)</td>
                          <td>
                            {{
                            criteria.detailed_feedback.breakdown.clarity.score
                            }}/10
                          </td>
                        </tr>
                        {% endif %} {% endif %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- Unmapped Guide Items Summary -->
{% if result.metadata.unmapped_guide_count is defined and
result.metadata.unmapped_guide_count > 0 %}
<div class="card mb-4">
  <div class="card-header bg-warning text-dark">
    <h5 class="mb-0">Unmapped Guide Items</h5>
    <small class="text-dark-50"
      >Guide items that couldn't be matched to the submission</small
    >
  </div>
  <div class="card-body">
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong>{{ result.metadata.unmapped_guide_count }} guide items</strong>
      couldn't be matched to the submission.
      <div class="mt-2">
        <a
          href="{{ url_for('view_mapping') }}"
          class="btn btn-sm btn-outline-warning"
        >
          <i class="bi bi-diagram-3 me-1"></i> View Mapping Details
        </a>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Actions -->
<div class="card mb-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">Actions</h5>
  </div>
  <div class="card-body">
    <div class="d-flex justify-content-between">
      <a href="{{ url_for('view_mapping') }}" class="btn btn-outline-secondary">
        <i class="bi bi-diagram-3 me-1"></i> View Mapping
      </a>
      <a href="{{ url_for('view_guide') }}" class="btn btn-outline-secondary">
        <i class="bi bi-file-text me-1"></i> View Marking Guide
      </a>
      <a
        href="{{ url_for('view_submission') }}"
        class="btn btn-outline-secondary"
      >
        <i class="bi bi-file-text me-1"></i> View Submission
      </a>
    </div>
  </div>
</div>

<!-- Debug Information -->
<div class="card mb-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">Debug Information</h5>
  </div>
  <div class="card-body">
    <p class="text-muted">
      This section shows the raw data structure to help diagnose any issues.
    </p>
    <pre
      class="bg-light p-3 rounded"
    ><code>{{ result|tojson(indent=2) }}</code></pre>
  </div>
</div>

<div class="d-flex justify-content-between mt-4">
  <a href="{{ url_for('index') }}" class="btn btn-secondary">
    <i class="bi bi-arrow-left me-1"></i> Back to Home
  </a>

  <div>
    <a href="{{ url_for('download_excel') }}" class="btn btn-success me-2">
      <i class="bi bi-file-excel me-1"></i> Download Excel
    </a>
    <a
      href="{{ url_for('clear_all') }}"
      class="btn btn-danger"
      onclick="return confirm('Are you sure you want to clear all data?');"
    >
      <i class="bi bi-trash me-1"></i> Clear All
    </a>
  </div>
</div>
{% endblock %} {% block extra_css %}
<style>
  .score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 2rem;
    font-weight: bold;
    color: white;
  }

  pre code {
    font-family: monospace;
    white-space: pre-wrap;
    font-size: 0.85rem;
  }

  .progress {
    background-color: #e9ecef;
    border-radius: 0.25rem;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .progress-bar {
    transition: width 0.6s ease;
  }

  .guide-text,
  .submission-text {
    white-space: pre-wrap;
    font-family: var(--font-mono);
    font-size: 0.9rem;
  }

  .guide-answer,
  .submission-answer {
    white-space: pre-wrap;
    font-family: var(--font-mono);
    font-size: 0.85rem;
  }

  .marks-badge {
    margin-top: 0.5rem;
    font-weight: 500;
  }

  .list-group-item {
    border-left: 4px solid #6c757d;
  }

  .list-group-item:hover {
    background-color: #f8f9fa;
  }
</style>
{% endblock %}
