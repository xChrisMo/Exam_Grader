{% extends "layout.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Grading Results</h1>
                <p class="mt-2 text-sm text-gray-600">
                    Detailed grading results and feedback for the submitted work.
                </p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportResults()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export Results
                </button>
                <a href="{{ url_for('dashboard') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Overall Score Card -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Overall Score</h3>
                    <p class="mt-1 text-sm text-gray-500">Total points achieved</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-primary-600">
                        {{ results.total_score if results and results.total_score else session.get('last_score', 0) }}%
                    </div>
                    <div class="text-sm text-gray-500">
                        {% set score = results.total_score if results and results.total_score else session.get('last_score', 0) %}
                        {% if score >= 90 %}
                            <span class="text-success-600 font-medium">Excellent</span>
                        {% elif score >= 80 %}
                            <span class="text-success-600 font-medium">Good</span>
                        {% elif score >= 70 %}
                            <span class="text-warning-600 font-medium">Satisfactory</span>
                        {% elif score >= 60 %}
                            <span class="text-warning-600 font-medium">Needs Improvement</span>
                        {% else %}
                            <span class="text-danger-600 font-medium">Unsatisfactory</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Score Breakdown -->
            <div class="mt-6">
                <div class="bg-gray-200 rounded-full h-3">
                    {% set score = results.total_score if results and results.total_score else session.get('last_score', 0) %}
                    <div class="h-3 rounded-full {% if score >= 80 %}bg-success-500{% elif score >= 60 %}bg-warning-500{% else %}bg-danger-500{% endif %}" style="width: {{ score }}%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-500 mt-2">
                    <span>0%</span>
                    <span>50%</span>
                    <span>100%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Question-by-Question Results -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">Question-by-Question Breakdown</h3>
            
            {% if results and results.questions %}
                {% for question in results.questions %}
                <div class="border-b border-gray-200 pb-6 mb-6 last:border-b-0 last:pb-0 last:mb-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="text-md font-medium text-gray-900">Question {{ loop.index }}</h4>
                            <p class="mt-1 text-sm text-gray-600">{{ question.text or 'Question text not available' }}</p>
                        </div>
                        <div class="ml-4 text-right">
                            <div class="text-lg font-semibold {% if question.score >= question.max_score * 0.8 %}text-success-600{% elif question.score >= question.max_score * 0.6 %}text-warning-600{% else %}text-danger-600{% endif %}">
                                {{ question.score }}/{{ question.max_score }}
                            </div>
                            <div class="text-sm text-gray-500">
                                {{ ((question.score / question.max_score) * 100)|round(1) }}%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student Answer -->
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Student Answer:</h5>
                        <div class="mt-2 p-3 bg-gray-50 rounded-md">
                            <p class="text-sm text-gray-900">{{ question.student_answer or 'No answer provided' }}</p>
                        </div>
                    </div>
                    
                    <!-- Feedback -->
                    {% if question.feedback %}
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Feedback:</h5>
                        <div class="mt-2 p-3 bg-blue-50 rounded-md">
                            <p class="text-sm text-blue-900">{{ question.feedback }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Expected Answer -->
                    {% if question.expected_answer %}
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Expected Answer:</h5>
                        <div class="mt-2 p-3 bg-green-50 rounded-md">
                            <p class="text-sm text-green-900">{{ question.expected_answer }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <!-- Mock Questions for Demo -->
                <div class="border-b border-gray-200 pb-6 mb-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="text-md font-medium text-gray-900">Question 1</h4>
                            <p class="mt-1 text-sm text-gray-600">Explain the concept of machine learning and its applications.</p>
                        </div>
                        <div class="ml-4 text-right">
                            <div class="text-lg font-semibold text-success-600">8/10</div>
                            <div class="text-sm text-gray-500">80%</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Student Answer:</h5>
                        <div class="mt-2 p-3 bg-gray-50 rounded-md">
                            <p class="text-sm text-gray-900">Machine learning is a subset of artificial intelligence that enables computers to learn and make decisions from data without being explicitly programmed. It has applications in healthcare, finance, and autonomous vehicles.</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Feedback:</h5>
                        <div class="mt-2 p-3 bg-blue-50 rounded-md">
                            <p class="text-sm text-blue-900">Good understanding of the basic concept. Could have included more specific examples of algorithms and mentioned supervised vs unsupervised learning.</p>
                        </div>
                    </div>
                </div>

                <div class="border-b border-gray-200 pb-6 mb-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="text-md font-medium text-gray-900">Question 2</h4>
                            <p class="mt-1 text-sm text-gray-600">Describe the difference between supervised and unsupervised learning.</p>
                        </div>
                        <div class="ml-4 text-right">
                            <div class="text-lg font-semibold text-warning-600">6/10</div>
                            <div class="text-sm text-gray-500">60%</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Student Answer:</h5>
                        <div class="mt-2 p-3 bg-gray-50 rounded-md">
                            <p class="text-sm text-gray-900">Supervised learning uses labeled data while unsupervised learning doesn't use labels.</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Feedback:</h5>
                        <div class="mt-2 p-3 bg-blue-50 rounded-md">
                            <p class="text-sm text-blue-900">Correct but incomplete. Should have provided examples and explained the goals of each approach (prediction vs pattern discovery).</p>
                        </div>
                    </div>
                </div>

                <div class="pb-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="text-md font-medium text-gray-900">Question 3</h4>
                            <p class="mt-1 text-sm text-gray-600">What are the main challenges in implementing machine learning systems?</p>
                        </div>
                        <div class="ml-4 text-right">
                            <div class="text-lg font-semibold text-success-600">9/10</div>
                            <div class="text-sm text-gray-500">90%</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Student Answer:</h5>
                        <div class="mt-2 p-3 bg-gray-50 rounded-md">
                            <p class="text-sm text-gray-900">Main challenges include data quality issues, overfitting, computational requirements, interpretability of models, and ensuring fairness and avoiding bias in algorithms.</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="text-sm font-medium text-gray-700">Feedback:</h5>
                        <div class="mt-2 p-3 bg-blue-50 rounded-md">
                            <p class="text-sm text-blue-900">Excellent comprehensive answer covering most key challenges. Shows good understanding of practical implementation issues.</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Summary and Recommendations -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Summary and Recommendations</h3>
            
            <div class="prose prose-sm text-gray-600">
                {% if results and results.feedback %}
                    <p>{{ results.feedback }}</p>
                {% else %}
                    <p>The student demonstrates a solid understanding of machine learning concepts with room for improvement in providing more detailed explanations and specific examples. Focus areas for improvement include:</p>
                    <ul class="mt-4 space-y-2">
                        <li>• Providing more specific examples when explaining concepts</li>
                        <li>• Including technical details about algorithms and methodologies</li>
                        <li>• Discussing practical implementation challenges</li>
                        <li>• Connecting theoretical concepts to real-world applications</li>
                    </ul>
                    
                    <p class="mt-4">Overall, this is a good performance that shows understanding of fundamental concepts. With more detailed explanations and examples, the student can achieve even better results.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportResults() {
    // Mock export functionality
    const results = {
        overall_score: {{ results.total_score if results and results.total_score else session.get('last_score', 0) }},
        timestamp: new Date().toISOString(),
        questions: [
            { question: 1, score: 8, max_score: 10, percentage: 80 },
            { question: 2, score: 6, max_score: 10, percentage: 60 },
            { question: 3, score: 9, max_score: 10, percentage: 90 }
        ]
    };
    
    const dataStr = JSON.stringify(results, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'grading_results_' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
}
</script>
{% endblock %}
