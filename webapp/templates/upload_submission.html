{% extends "layout.html" %}
{% block content %}
<div class="max-w-3xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Upload Student Submissions</h1>
        <p class="mt-2 text-sm text-gray-600">
            Upload student exam papers for automated grading. Supported formats: PDF, Word documents, and images.
        </p>
    </div>

    <!-- Upload Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <form method="POST" enctype="multipart/form-data" id="upload-form">
                {% if csrf_token %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                {% endif %}
                <!-- Marking Guide Selection -->
                <div class="mb-6">
                    <label for="marking_guide_id" class="block text-sm font-medium text-gray-700 mb-2">Select Marking Guide</label>
                    <select id="marking_guide_id" name="marking_guide_id" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                        <option value="">-- Select a Marking Guide --</option>
                        {% for guide in marking_guides %}
                        <option value="{{ guide.id }}">{{ guide.filename }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- File Upload Area -->
                <div class="mb-6">
                    <label for="files" class="block text-sm font-medium text-gray-700 mb-2">
                        Student Submission Files
                    </label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-primary-400 transition-colors duration-200" id="drop-zone">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="files" class="relative cursor-pointer bg-white rounded-md font-medium text-primary-600 hover:text-primary-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500">
                                    <span>Upload files</span>
                                    <input id="files" name="files" type="file" class="sr-only" accept=".pdf,.docx,.doc,.jpg,.jpeg,.png,.tiff,.bmp,.gif" multiple required>
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">
                                PDF, Word documents, or images up to 16MB each
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Selected Files List -->
                <div id="fileListContainer" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selected Files</label>
                    <ul id="fileList" class="border border-gray-300 rounded-md bg-white divide-y divide-gray-200 max-h-60 overflow-y-auto">
                        <!-- Files will be listed here -->
                    </ul>
                </div>

                <!-- Processing Options -->
                <div class="mb-6 bg-gray-50 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Processing Options</label>
                    <div class="flex items-center mb-2">
                        <input id="process_mode_parallel" name="process_mode" type="radio" value="parallel" class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300" checked>
                        <label for="process_mode_parallel" class="ml-2 block text-sm text-gray-900">Process in Parallel (faster for many files)</label>
                    </div>
                    <div class="flex items-center mb-4">
                        <input id="process_mode_sequential" name="process_mode" type="radio" value="sequential" class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300">
                        <label for="process_mode_sequential" class="ml-2 block text-sm text-gray-900">Process Sequentially (for debugging or resource-limited systems)</label>
                    </div>

                    <label for="batch_size" class="block text-sm font-medium text-gray-700 mb-2">Batch Size (for parallel processing)</label>
                    <input type="number" id="batch_size" name="batch_size" value="5" min="1" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="hidden mb-6">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Uploading and processing...</p>
                </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-between">
                    <a href="{{ url_for('dashboard') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back to Dashboard
                    </a>
                    
                    <button type="submit" id="submit-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Upload Submissions
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Processing Results Section -->
    <div id="results-section" class="hidden mt-8 bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Processing Results</h2>
        <div id="processing-summary" class="mb-4 text-sm text-gray-700">
            <!-- Summary will be displayed here -->
        </div>
        <div id="results-list" class="divide-y divide-gray-200">
            <!-- Results for each file will be displayed here -->
        </div>
        <div class="mt-6 text-right">
            <a href="{{ url_for('dashboard') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Help Section -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Tips for best results</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <ul class="list-disc list-inside space-y-1">
                        <li>Ensure student submissions are clear and legible.</li>
                        <li>For best OCR results, use high-quality scans or images.</li>
                        <li>PDF and Word documents generally yield better parsing accuracy.</li>
                        <li>Review the processing results for any errors or discrepancies.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('files'); // Changed from guide_file to files
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const submitBtn = document.getElementById('submit-btn');
        const uploadForm = document.getElementById('upload-form');
        const resultsSection = document.getElementById('results-section');
        const processingSummary = document.getElementById('processing-summary');
        const resultsList = document.getElementById('results-list');

        let selectedFiles = [];

        // Initialize drag and drop and file input using ExamGrader utilities
        if (dropZone && fileInput) {
            ExamGrader.fileUpload.initDragAndDrop(dropZone, fileInput, handleFiles);
        }

        // Handle files selected via input or drag/drop
        function handleFiles(files) {
            console.log('Files received:', files);
            let filesToAdd = Array.from(files);

            // If single file input, replace existing selection
            if (!fileInput.multiple) {
                selectedFiles = [];
                if (filesToAdd.length > 1) {
                    ExamGrader.utils.showToast('Only one file can be selected for this input.', 'warning');
                    filesToAdd = [filesToAdd[0]]; // Take only the first file
                }
            }

            const newFiles = [];
            filesToAdd.forEach(file => {
                const errors = ExamGrader.fileUpload.validateFile(file);
                if (errors.length > 0) {
                    errors.forEach(error => ExamGrader.utils.showToast(error, 'error'));
                } else {
                    // Check for duplicates before adding
                    const isDuplicate = selectedFiles.some(existingFile => 
                        existingFile.name === file.name && existingFile.size === file.size
                    );
                    if (!isDuplicate) {
                        newFiles.push(file);
                    } else {
                        ExamGrader.utils.showToast(`Duplicate file skipped: ${file.name}`, 'info');
                    }
                }
            });
            selectedFiles.push(...newFiles);
            updateFileList();
        }

        // Update the displayed list of selected files
        function updateFileList() {
            if (!fileList) return; // Ensure fileList exists
            fileList.innerHTML = '';
            if (selectedFiles.length > 0) {
                if (fileListContainer) fileListContainer.classList.remove('hidden');
                selectedFiles.forEach((file, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item flex justify-between items-center p-3 hover:bg-gray-50';
                    listItem.innerHTML = `
                        <span class="text-sm text-gray-800">${file.name} (${ExamGrader.utils.formatFileSize(file.size)})</span>
                        <button type="button" class="remove-file-btn text-gray-400 hover:text-gray-600" data-index="${index}">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    `;
                    fileList.appendChild(listItem);
                });
            } else {
                if (fileListContainer) fileListContainer.classList.add('hidden');
            }
        }

        // Remove file from list
        if (fileList) {
            fileList.addEventListener('click', function(e) {
                if (e.target.closest('.remove-file-btn')) {
                    const index = parseInt(e.target.closest('.remove-file-btn').dataset.index);
                    selectedFiles.splice(index, 1);
                    updateFileList();
                    ExamGrader.utils.showToast('File removed.', 'info');
                }
            });
        }

        // Form submission with progress
        if (uploadForm) {
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (selectedFiles.length === 0) {
                    ExamGrader.utils.showToast('Please select at least one file to upload.', 'error');
                    return;
                }

                const markingGuideId = document.getElementById('marking_guide_id').value;
                if (!markingGuideId) {
                    alert('Please select a marking guide.');
                    return;
                }

                const formData = new FormData();
                formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
                formData.append('marking_guide_id', markingGuideId);
                formData.append('process_mode', document.querySelector('input[name="process_mode"]:checked').value);
                formData.append('batch_size', document.getElementById('batch_size').value);

                selectedFiles.forEach(file => {
                    formData.append('files', file); // Append each file with the same name 'files'
                });
                
                // Show progress
                if (uploadProgress) uploadProgress.classList.remove('hidden');
                if (resultsSection) resultsSection.classList.add('hidden'); // Hide results section during new upload
                if (typeof ExamGrader !== 'undefined' && ExamGrader.utils) {
                        ExamGrader.utils.showButtonLoading(submitBtn, 'Processing...');
                    }

                try {
                    const response = await fetch('/upload-submission', {
                        method: 'POST',
                        body: formData,
                        // No 'Content-Type' header needed for FormData, browser sets it with boundary
                    });

                    if (response.ok) {
                        setTimeout(() => {
                            window.location.href = response.url || '{{ url_for("dashboard") }}';
                        }, 500);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Upload failed');
                    }

                } catch (error) {
                    console.error('Upload error:', error);
                    ExamGrader.utils.showToast('An error occurred during upload: ' + error.message, 'error');
                } finally {
                    if (uploadProgress) uploadProgress.classList.add('hidden');
                    if (typeof ExamGrader !== 'undefined' && ExamGrader.utils) {
                        ExamGrader.utils.hideButtonLoading(submitBtn, 'Upload Submissions');
                    }
                    // Clear selected files after processing attempt
                    selectedFiles = [];
                    updateFileList();
                }
            });
        }
    });
</script>
{% endblock %}