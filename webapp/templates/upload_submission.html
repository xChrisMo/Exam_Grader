{% extends "layout.html" %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900" data-i18n="upload_submission_title">Upload Student Submission</h1>
        <p class="mt-2 text-sm text-gray-600" data-i18n="upload_submission_description">
            Upload student submissions for automated grading. Supported formats: PDF, Word documents, and images with OCR processing.
        </p>
        {% if guide_id %}
        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
            <p class="text-sm text-blue-700">
                <i class="fas fa-info-circle mr-1"></i>
                Using marking guide: {{ guide_id }}
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Upload Form -->
    <div class="bg-white shadow rounded-lg" data-upload-container>
        <div class="px-4 py-5 sm:p-6">
            <!-- Message Display Area -->
            <div class="upload-messages mb-4"></div>
            <form method="POST" enctype="multipart/form-data" id="upload-form" data-upload-form>
                {% if csrf_token %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                {% endif %}
                {% if guide_id %}
                <input type="hidden" name="guide_id" value="{{ guide_id }}" />
                {% endif %}
                
                <!-- Student Information -->
                <div class="mb-6">
                    <label for="student_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Student Name (Optional)
                    </label>
                    <input type="text" id="student_name" name="student_name" 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                           placeholder="Enter student name">
                </div>

                <!-- File Upload Area -->
                <div class="mb-6">
                    <label for="submission_files" class="block text-sm font-medium text-gray-700 mb-2"
                        data-i18n="submission_files">
                        Submission Files
                    </label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-primary-400 transition-colors duration-200"
                        id="drop-zone">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                viewBox="0 0 48 48">
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="submission_files"
                                    class="relative cursor-pointer bg-white rounded-md font-medium text-primary-600 hover:text-primary-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500">
                                    <span data-i18n="upload_files">Upload files</span>
                                    <input id="submission_files" name="submission_files" type="file" class="sr-only"
                                        accept=".pdf,.docx,.doc,.jpg,.jpeg,.png,.tiff,.bmp,.gif" multiple required
                                        data-max-size="104857600">
                                </label>
                                <p class="pl-1" data-i18n="or_drag_and_drop">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500" data-i18n="file_types_hint">
                                PDF, Word documents, or images up to 100MB each
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Selected Files Display -->
                <div id="selected-files" class="mb-6 hidden">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Selected Files:</h3>
                    <div id="file-list" class="space-y-2"></div>
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="mb-6 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700" id="upload-status">Preparing upload...</span>
                        <span id="progress-text" class="text-sm text-gray-500">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" id="submit-btn"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-upload mr-2"></i>
                        <span data-i18n="upload_submission">Upload Submission</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Section -->
    <div class="mt-8 bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-question-circle mr-2"></i>
            Upload Guidelines
        </h3>
        <ul class="space-y-2 text-sm text-gray-600">
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                Supported formats: PDF, Word documents (.docx, .doc), and images (.jpg, .jpeg, .png, .tiff, .bmp, .gif) with OCR processing
            </li>
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                No file size limits - unlimited processing
            </li>
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                You can upload multiple files for a single submission
            </li>
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                Make sure you have uploaded a marking guide before uploading submissions
            </li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('submission_files');
    const dropZone = document.getElementById('drop-zone');
    const selectedFilesDiv = document.getElementById('selected-files');
    const fileListDiv = document.getElementById('file-list');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const submitBtn = document.getElementById('submit-btn');
    const messagesDiv = document.querySelector('.upload-messages');

    // File selection handler
    fileInput.addEventListener('change', handleFileSelection);
    
    // Drag and drop handlers
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    dropZone.addEventListener('dragleave', handleDragLeave);

    function handleFileSelection(e) {
        const files = e.target.files;
        displaySelectedFiles(files);
    }

    function handleDragOver(e) {
        e.preventDefault();
        dropZone.classList.add('border-primary-400', 'bg-primary-50');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary-400', 'bg-primary-50');
    }

    function handleDrop(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary-400', 'bg-primary-50');
        
        const files = e.dataTransfer.files;
        fileInput.files = files;
        displaySelectedFiles(files);
    }

    function displaySelectedFiles(files) {
        if (files.length === 0) {
            selectedFilesDiv.classList.add('hidden');
            return;
        }

        fileListDiv.innerHTML = '';
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
            fileDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-file mr-2 text-gray-500"></i>
                    <span class="text-sm text-gray-700">${file.name}</span>
                    <span class="text-xs text-gray-500 ml-2">(${formatFileSize(file.size)})</span>
                </div>
            `;
            fileListDiv.appendChild(fileDiv);
        }
        selectedFilesDiv.classList.remove('hidden');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showMessage(message, type = 'info') {
        const alertClass = type === 'error' ? 'bg-red-50 border-red-200 text-red-700' : 
                          type === 'success' ? 'bg-green-50 border-green-200 text-green-700' :
                          type === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-700' :
                          'bg-blue-50 border-blue-200 text-blue-700';
        
        messagesDiv.innerHTML = `
            <div class="rounded-md border p-4 ${alertClass}">
                <div class="flex">
                    <div class="ml-3">
                        <p class="text-sm">${message}</p>
                    </div>
                </div>
            </div>
        `;
    }

    function showDetailedMessage(message, type = 'info') {
        const alertClass = type === 'error' ? 'bg-red-50 border-red-200 text-red-700' : 
                          type === 'success' ? 'bg-green-50 border-green-200 text-green-700' :
                          type === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-700' :
                          'bg-blue-50 border-blue-200 text-blue-700';
        
        const iconClass = type === 'error' ? 'fas fa-exclamation-triangle text-red-500' :
                         type === 'success' ? 'fas fa-check-circle text-green-500' :
                         type === 'warning' ? 'fas fa-exclamation-triangle text-yellow-500' :
                         'fas fa-info-circle text-blue-500';
        
        // Convert newlines to HTML breaks and format bullet points
        const formattedMessage = message
            .replace(/\n/g, '<br>')
            .replace(/• /g, '<span class="inline-block w-2 text-center">•</span> ');
        
        messagesDiv.innerHTML = `
            <div class="rounded-md border p-4 ${alertClass}">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-sm" style="white-space: pre-line;">${formattedMessage}</div>
                    </div>
                </div>
            </div>
        `;
    }

    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (fileInput.files.length === 0) {
            showMessage('Please select at least one file to upload.', 'error');
            return;
        }

        // Prevent multiple submissions
        if (submitBtn.disabled) {
            return;
        }

        const formData = new FormData(form);
        
        // Show progress
        progressDiv.classList.remove('hidden');
        submitBtn.disabled = true;
        
        // Clear any existing messages
        messagesDiv.innerHTML = '';
        
        // Multi-stage progress tracking for submissions
        const xhr = new XMLHttpRequest();
        let currentStage = 'uploading';
        let responseHandled = false;
        
        // Progress stages with their weights for submissions
        const stages = {
            uploading: { weight: 30, label: 'Uploading files...' },
            processing: { weight: 35, label: 'Processing submissions...' },
            validating: { weight: 25, label: 'Validating content...' },
            storing: { weight: 10, label: 'Storing submissions...' }
        };
        
        function updateProgress(stage, stagePercent = 0) {
            currentStage = stage;
            
            // Calculate overall progress
            let totalProgress = 0;
            
            for (const [stageName, stageInfo] of Object.entries(stages)) {
                if (stageName === stage) {
                    totalProgress += (stagePercent / 100) * stageInfo.weight;
                    break;
                } else if (Object.keys(stages).indexOf(stageName) < Object.keys(stages).indexOf(stage)) {
                    totalProgress += stageInfo.weight;
                }
            }
            
            // Update progress bar and text
            progressBar.style.width = Math.min(totalProgress, 95) + '%';
            progressText.textContent = stages[stage].label + ' ' + Math.round(totalProgress) + '%';
        }
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable && currentStage === 'uploading') {
                const uploadPercent = (e.loaded / e.total) * 100;
                updateProgress('uploading', uploadPercent);
            }
        });
        
        xhr.addEventListener('load', function() {
            if (responseHandled) return;
            responseHandled = true;
            
            if (xhr.status === 200) {
                // Upload complete, show processing stages
                updateProgress('processing', 0);
                
                setTimeout(() => updateProgress('processing', 60), 300);
                setTimeout(() => updateProgress('validating', 0), 1000);
                setTimeout(() => updateProgress('validating', 80), 1800);
                setTimeout(() => updateProgress('storing', 0), 2800);
                setTimeout(() => {
                    updateProgress('storing', 100);
                    
                    // Complete the progress
                    setTimeout(() => {
                        progressBar.style.width = '100%';
                        progressText.textContent = 'Complete! 100%';
                        
                        setTimeout(() => {
                            progressDiv.classList.add('hidden');
                            submitBtn.disabled = false;
                            
                            try {
                                const response = JSON.parse(xhr.responseText);
                                
                                if (response.status === 'success' && response.failed_count === 0) {
                                    // All files succeeded
                                    showMessage(response.message || 'All submissions uploaded successfully!', 'success');
                                    setTimeout(() => {
                                        window.location.href = '/submissions';
                                    }, 2000);
                                } else if (response.status === 'success' || response.status === 'partial_failure') {
                                    // Some files succeeded, some failed - show detailed information
                                    let detailedMessage = response.message || 'Upload completed with some issues.';
                                    
                                    if (response.errors && response.errors.length > 0) {
                                        detailedMessage += '\n\nFailed files:';
                                        response.errors.forEach(error => {
                                            detailedMessage += `\n• ${error.filename}: ${error.error}`;
                                        });
                                    }
                                    
                                    const messageType = response.uploaded_count > 0 ? 'warning' : 'error';
                                    showDetailedMessage(detailedMessage, messageType);
                                    
                                    if (response.uploaded_count > 0) {
                                        setTimeout(() => {
                                            window.location.href = '/submissions';
                                        }, 5000); // Give more time to read the detailed errors
                                    }
                                } else {
                                    showMessage(response.error || response.message || 'Upload failed', 'error');
                                }
                            } catch (e) {
                                showMessage('Upload completed but response was invalid', 'error');
                            }
                        }, 500);
                    }, 200);
                }, 3500);
            } else {
                // Handle error responses immediately
                progressDiv.classList.add('hidden');
                submitBtn.disabled = false;
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    showMessage(response.error || response.message || 'Upload failed. Please try again.', 'error');
                } catch (e) {
                    showMessage('Upload failed. Please try again.', 'error');
                }
            }
        });
        
        xhr.addEventListener('error', function() {
            if (responseHandled) return;
            responseHandled = true;
            
            progressDiv.classList.add('hidden');
            submitBtn.disabled = false;
            showMessage('Upload failed. Please check your connection and try again.', 'error');
        });
        
        xhr.open('POST', form.action || window.location.pathname);
        
        // Set CSRF token header (must be after xhr.open())
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
    });
});
</script>
{% endblock %}