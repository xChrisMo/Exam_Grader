{% extends "layout.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Hidden CSRF Token -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Enhanced AI Processing Pipeline</h1>
        <p class="mt-2 text-lg text-gray-600">
            Complete LLM-driven workflow for marking guide processing, submission mapping, and intelligent grading
        </p>
    </div>

    <!-- Processing Steps Overview -->
    <div class="mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Pipeline</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">1. Guide Processing</h3>
                    <p
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <p>
                        </>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">2. Submission Mapping</h3>
                    <pions</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <p
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">3. AI Grading</h3>
                    <p>
                </iv>
            </>
        </
/div>

    <!-- Main Processing Interface -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Column: Guide-->
        <div class="space-y-6">
            <!-- Marking Guide Selection -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg fontGuide</h3>
                <div class="space-y-4">
                    <select id="markingGuideSelect" class="w-full px-3 py-200">
                        <opti>
                    </select>
                    <div id="guideInfo" class="hidden bg-gray-50 p-4 rounded-md">
                        <h4 class="font-medium text-gray-900">Gu
                        <div class="mt-2 text-sm text-gray-600">
                            <p><span class="font-medium">Title:</span> <span id="guideTitle"></span></p>
                            <p><span class="font-medium">Questions:</span> <span id="guideQuestions"></span></p>
                            <p><span class="font-medium">Total Marks:</span> <span id="guideTotalMarks"></p>
                            <ppan></p>
                        </
div>
                </div>
            </div>

            <!-- Submission Selection -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Select Submissions</h3>
                <div class="space-y-4">
                    <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-md">
                        <div id="submissionsList" class="divide-y divide-gray-200">
                            <p class="p-4 text-gray-500 text-center">Select a marking guide first</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center">
                            <input type="checkbox" id="selectAllSubmissions" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Select All</span>
                        </label>
                        <span id="selectedCount" class="text-sm text-gray-500">0 selected</span>
                    </div>
                </div>
            </div>

            <!-- Processing Options -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Processing Options</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Questions to Answer</label>
                        <input type="number" id="maxQuestions" min="1" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Leave empty for all questions">
                        <p class="mt-1 text-xs text-gray-500">Limit the number of questions to grade (best answers will be selected)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Processing Steps</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="processGradingStep" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Process Grading</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-2">
                                Note: Marking guides and submissions have already been processed and saved to the database.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Processing Status and Results -->
        <div class="space-y-6">
            <!-- Processing Controls -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Processing Controls</h3>
                <div class="space-y-4">
                    <button id="startBatchProcessing" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Start Batch Processing
                    </button>
                    <button id="stopProcessing" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Stop Processing
                    </button>
                </div>
            </div>

            <!-- Processing Status -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Processing Status</h3>
                <div id="processingStatus" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>No processing in progress</p>
                    </div>
                </div>
            </div>

            <!-- Results Summary -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Results Summary</h3>
                <div id="resultsSummary" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p>No results available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Results Table -->
    <div class="mt-8">
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Detailed Results</h3>
            </div>
            <div class="overflow-x-auto">
                <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submission</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processing Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Questions Graded</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">No results to display</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div id="processingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                <svg class="animate-spin h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" id="modalTitle">Processing...</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="modalMessage">Please wait while we process your request.</p>
                <div class="mt-4">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="modalProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class EnhancedProcessingManager {
    constructor() {
        this.selectedGuideId = null;
        this.selectedSubmissions = new Set();
        this.isProcessing = false;
        this.processingInterval = null;
        
        
        this.initializeEventListeners();
        // Delay loading mated
        setTimeout(() => {
            thiss();
     500);
    }
    
    initializeEventListene{
        // Guide selection
        document.getElementById('markingGuideSelect'
           ue);
        ;
     
        
        document.getElementById('> {
            this.toggleAllSubmissions(e.target.checked);
        });
        
        sing
        document.getElement, () => {
            this.startBatchProcessing();
        });
        
        > {
            this.stopProcessing();
        });
    }
    
    ) {
        try {
            c);
            
            
            if (!response.ok) {
                throw new Error;
            }
            
            pe');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Response is not JSON - you may need to log gain');
            }
            
            
            
            
            this.guides = data.guides || [];
            
            
            select.innerHTML = '<option valu';
            
            if (data.success && this.guides.length > 0) {
                this.guides.forEach(guide => {
                    const option = document.createElement('option');
                    option.value = guide.id;
                   
                    
                });
            }
                this.show
            }
        } catch (error) {
            console.error('Error loading markin
            if (erro')) {
                this.showAuthenticationError();
            }lse {
         
          }
    
    }
    
    asyn{
        this.selectedGueId;
        
        if (!guideId) {
            documendden');
         t</p>';
           return;
        }
        
        try {
            // Find guide data from the already loaded gues
            eId);
            if (!guideData) {
                throw new Error('Guide not found in lo;
            }
            
            // Display guide info directly fro
            this.displayGuideInfo(guideData);
            
            de
            const submissionsResponse = aw
            const submissionsData = await submissionsResponse.on();
            
            if (submissio {
                this.displaySubmissions(submissionsData.submisions);
            }
        }
     );
    n');
        }
    }
    
    displayGuideInfo(guide) {
        document.getElementById('guideTitle').textContent = guide.title;
        document.getElementById('guideQuestions').textContent = guide.qu
     
    ';
        document.getElementById('guid
    }
    
    displaySubmissions(submissions) {
        const container = document.getElementById('submissionsList');
        
        i {
        ';
            return;
        }
        
        container.innerHTML = '';
        submissions.forEach(s{
            const div = document.createElement('div');
            div.className = 'p-4 hover:bg-gray-50';
            div.innerHTML = `
                <label class="flex items-cent>
                    <input type="checkbox" class="submission-checkbox rounded border-gray-300 text-blue 
                           value="${submission.id}" data-student-name="${submission.stu">
                    <div class="ml-3 flex-1">
                        <d
                        div>
              v>
                    </div>
           /label>
           `;
            container.appendChild(div);
        });
        
        // Add event listeners to checkboxes
        containckbox => {
           > {
     );
    
        });
    }
    
    toggleA
        document.querySelectorAll('.submi{
     
    
        this.updateSelectedSubmiss();
    }
    
    updateSelectedSubmissions() {
        thi
         => {
            this.selectedSubmissions.add(checkbox.value);
        );
        
        document.getElementById('selectedCount').textContent = `${this.selectedSubd`;
        
        // Update select all checkbox
     ons');
    ');
        selectAllCheckbox.checkedh;
    }
    
    async startBatcng() {
        i) {
        ');
            return;
        }
        
        if (this.selectedSubmissions.size === 0) {
            this.showError('Pleon');
            return;
        }
        
        const maxQ.value;
        const processSteps = [];
        
        if (docume
        
        if (
            this.showError('Please enable gradi
            urn;
        }
        
        this.isProcessing = true;
        this.updateProcessingControls();
        
        this.showMod;
        
        try {
            c
                method: ',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
         ,
     {
    issions),
                    marking_guide_uideId,
                    max_questions_toll,
                    process_steps: processSteps
                })
         
            
            const data = await response.json();
            
            this.hiModal();
         
        
                this.displayBatchResults(data.data);
                this.showSuccess!');
        else {
                this.showError(data.message || data.error || 'Batch processing failed');
         }
        } catch (error) {
            this.hideModal();
            consolerror);
         failed');
        
            this.isProcessing = false;
            this.updateProcessingControl
        }
    }
    
    stopProceing() {
        this.isProcessing = false;
        this.updateProcessingCo
        this.hideModal();
        this.showInfo('Processing stopped');
    }
    
    updateProcessingControls() {
        document.getElementById('startBatchProcessing').disabled = this.ising;
        document.getElementById('stopProcessing').disabled 
    }
    
    displayBatchResults) {
        // Stor
        this
        
        // U
        const summary = resul
        cons
        
        summaryContainer.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <divded-lg">
                    <div class="text-2xl font-bold text-green-600">${summary.successful_>
             >
                </div>
                <div class="b
                    <div class="text-2xl font-bold text-red-600</div>
                    <div class="text-sm text-red-600"></div>
                </div>
                <div class="bg-blue-50">
                    <div class="text-2xl fonng}</div>
         
     v>
    
                    <d
                    <div class="te</div>
                </div>
            </div>
        `;
        
    
        this.updateResultsTable();
    }
    
    u
    y');
        tbody.innerHTML = '';
        
        for (const [submissionId, gradin
            const row = document.createElement('tr');
         `
                <td class="px-6 py-4 w/td>
                <td class="px-6 py-4 whitespace->
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                        gradingResult.success ? 'bg-green-100 text-green-800' : '
                    }"
                        ${gradingResult.success ? 'Com
                    </span>
                </td>
                <td cl>
                    ${gradingResult.success ? `${gradin'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gr0">
                    ${/A'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${gradingResult.success ? gradingResult.questions_graded :
                </td>
                <t-medium">
          >
        d>
            `;
            tbody.appendChild(row);
      }
    }
    
    showModal(title, message, progress = 0) {
        document.getElementBye;
        
        document.getElementById('modalProgress').style.width = `${progress}%`;
        document.getElementById('processingModal').classList.remove('hidden');
    }
    
    hideModal() {
        document.getElementById('processingModal').classList.add('hidden');
    }
    
    showAuthenticationError() {
        const notification = document.createElement('div');
        notification.cl
        notification.innerHTML = `
            <div class="flen">
                <div>
                    <strong>Authentication Required</strong><br>
                    Please log in again or refresh the page.
                </div
                <div class="ml-4">
                    <button onclick="window.location.reload()" class="bg-yellow--700">
                     
                    </button>
                </div>
            </div>
        `;
        
        document.body);
        
        setTimeout(() => {
         
     on);
    }
        }, 10000);
    }
    
    showSuccess(message) {
        this.showNotification(message, 'success');
    }
    
    showError(mes {
        this.showNotification(message, 'error');
    }
    
    showInfo(message) {
        this.showNotification(message, 'info');
    }
    
    showNotification(message, type) {
        const notification = document.createElement('div');
        let bgColor, 
        
        switch (type) {
            case 'success':
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                borderColor = 'borde300';
                break;
            case 'erro:
                bg100';
          
        
                break;
        
            default:
                bgColor = 0';
                textColor = 'text-blue-800
                borderColor = 'border-blue-300';
             
        }
     
    
        notification.innerTML = `
            <div class="flex items-center justify-
     
    >
                    ✕
                </button>
     /div>
    
        
        document.body.appendChild(notification);
     
    () => {
            if (notification.parentNo {
                notification.parentNodtion);
            }
        }, 5000);
    }
    
    getCSRFToken() {
        const tokenInput = document.query"]');
        if (tokenInput) {
            return tokenInput.value;
        }
        
        const tokenMeta = document.quern"]');
        if (tokenMeta) {
            return tokenMeta.getAttribute('contt');
        }
        
        const cookieit(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.tri;
            if (name === 'csrf_token') {
                return
          }
        }
        
        return '';
    }
}

// Initialize the enhs
document.addEventListener) {
    window.enhance
});

// Global function for viewing details
functionsionId) {
    const manager = window.enhancnager;
    if (manager && manager
        const result = manager.batchResultsionId];
        if (result) {
            l`
                <>
     d-lg">
    >
                    >
                            <div><span class="font-mediiv>
                            <div><span class="font-medium">Percentage:</span> '}%</div>
                         iv>
                            <div><sp
           </div>
           </div>
                    ${result.error ? `<div class="bg-red-50 p-4 rounded-lg">
                        h4>
                        <p class="text-red-700 text-srror}</p>
          ''}
        g">
                        <h4 class="font-sem
                        <p class="text-blue-700 tex>
                    </div>
                </div>
            `;
            
            m);
        }{
        
        }
    }
 

    }
}
</script>
{% endblock %}