{% extends "layout.html" %}

{% block content %}
<!-- Hidden CSRF Token -->
<input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Enhanced AI Processing Pipeline</h1>
        <p class="mt-2 text-lg text-gray-600">
            Complete LLM-driven workflow for marking guide processing, submission mapping, and intelligent grading
        </p>
    </div>

    <!-- Processing Steps Overview -->
    <div class="mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Pipeline</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">1. Guide Processing</h3>
                    <p class="text-sm text-gray-500">LLM extracts structured questions and answers from marking guides</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">2. Submission Mapping</h3>
                    <p class="text-sm text-gray-500">OCR + LLM intelligently maps student answers to guide questions</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">3. AI Grading</h3>
                    <p class="text-sm text-gray-500">LLM grades with max_questions_to_answer logic and detailed feedback</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Processing Form -->
    <form id="enhanced-processing-form" class="space-y-8">
        <!-- Select Marking Guide Section -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <span class="inline-flex items-center">
                    <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Step 1: Select Marking Guide
                </span>
            </h2>
            <p class="text-sm text-gray-600 mb-4">Choose the marking guide that will be used to grade the selected submissions.</p>
            <div class="mb-4">
                <select id="marking-guide-select" name="marking_guide_id" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Loading marking guides...</option>
                </select>
            </div>
            <div id="guide-info" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
                <div id="guide-details"></div>
            </div>
        </div>

        <!-- Select Submissions Section -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <span class="inline-flex items-center">
                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Step 2: Select Submissions
                </span>
            </h2>
            <p class="text-sm text-gray-600 mb-4">Choose the submissions that will be graded using the selected marking guide.</p>
            
            <!-- Dynamic Submission Loading Based on Selected Guide -->
            <div id="submissions-loading" class="text-gray-500 mb-4">Please select a marking guide first</div>
            <div id="submissions-container" class="hidden">
                <div class="mb-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Select submissions to process:</span>
                        <div class="space-x-2">
                            <button type="button" id="select-all-btn" class="text-sm text-blue-600 hover:text-blue-800">Select All</button>
                            <button type="button" id="clear-all-btn" class="text-sm text-gray-600 hover:text-gray-800">Clear All</button>
                        </div>
                    </div>
                </div>
                <div id="submissions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Submissions will be loaded here dynamically -->
                </div>
                <div id="selected-count" class="mt-4 text-sm text-gray-600">
                    0 submissions selected
                </div>
            </div>
        </div>
    </form>

    <!-- Processing Status Section -->
    <div class="mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Status</h2>
            <div id="processing-status" class="mb-4">
                <div class="text-gray-600">Ready to begin processing...</div>
            </div>
            
            <!-- Start Processing Button -->
            <button id="start-processing" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Start Enhanced Processing
            </button>
        </div>
    </div>

    <!-- Progress Section -->
    <div id="progress-section" class="mb-8 hidden">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Progress</h2>
            <div id="progress-container">
                <!-- Progress will be populated here -->
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Results</h2>
            <div id="results-container">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedGuide = null;
    let selectedSubmissions = [];
    let progressPollingInterval = null;
    let progressRetryCount = 0;
    const MAX_PROGRESS_RETRIES = 5;
    
    const startButton = document.getElementById('start-processing');
    const statusDiv = document.getElementById('processing-status');
    const progressSection = document.getElementById('progress-section');
    const resultsSection = document.getElementById('results-section');
    
    // Initialize the page
    initializePage();
    loadMarkingGuides();
    
    function initializePage() {
        selectedSubmissions = [];
        selectedGuide = null;
        
        const container = document.getElementById('submissions-container');
        const loadingDiv = document.getElementById('submissions-loading');
        
        if (container) {
            container.classList.add('hidden');
        }
        
        if (loadingDiv) {
            loadingDiv.textContent = 'Please select a marking guide first';
            loadingDiv.classList.remove('hidden');
        }
        
        updateProcessingButton();
        
        // Set up event listeners
        startButton.addEventListener('click', function() {
            if (selectedGuide && selectedSubmissions.length > 0) {
                startEnhancedProcessing();
            }
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            clearProgressPolling();
        });
    }
    
    async function loadMarkingGuides() {
        try {
            const response = await fetch('/refactored/api/marking-guides');
            const data = await response.json();
            
            if (data.success) {
                populateMarkingGuideSelect(data.guides || []);
            } else {
                throw new Error(data.error || 'Failed to load marking guides');
            }
        } catch (error) {
            console.error('Error loading marking guides:', error);
            const select = document.getElementById('marking-guide-select');
            if (select) {
                select.innerHTML = '<option value="">Error loading marking guides</option>';
            }
        }
    }
    
    function populateMarkingGuideSelect(guides) {
        const select = document.getElementById('marking-guide-select');
        
        if (!select) {
            console.error('Marking guide select element not found');
            return;
        }
        
        if (guides.length === 0) {
            select.innerHTML = '<option value="">No marking guides found. Please upload a marking guide first.</option>';
            return;
        }
        
        const optionsHtml = guides.map(guide => 
            `<option value="${guide.id}">${guide.title || guide.filename} (${guide.questions_count || 0} questions)</option>`
        ).join('');
        
        select.innerHTML = `<option value="">Select a marking guide...</option>${optionsHtml}`;
        
        // Add change handler for guide selection
        select.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue) {
                selectedGuide = selectedValue;
                const selectedGuideData = guides.find(g => g.id == selectedValue);
                showGuideInfo(selectedGuideData);
                loadSubmissionsForGuide(selectedValue);
            } else {
                selectedGuide = null;
                hideGuideInfo();
                hideSubmissions();
            }
            updateProcessingButton();
        });
    }
    
    function showGuideInfo(guide) {
        const guideInfo = document.getElementById('guide-info');
        const guideDetails = document.getElementById('guide-details');
        
        if (guideInfo && guideDetails && guide) {
            guideDetails.innerHTML = `
                <h4 class="font-medium text-gray-900 mb-4">${guide.title || guide.filename || 'Untitled Guide'}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="text-sm text-gray-600 space-y-2">
                        <p><strong>Questions extracted:</strong> ${guide.questions_count || 0}</p>
                        <p><strong>Total marks:</strong> ${guide.total_marks || 0}</p>
                        <p><strong>Created:</strong> ${new Date(guide.created_at).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> Active</p>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label for="max-questions-input" class="block text-sm font-medium text-gray-700 mb-1">
                                Max Questions to Answer
                            </label>
                            <div class="flex items-center space-x-2">
                                <input 
                                    type="number" 
                                    id="max-questions-input" 
                                    min="1" 
                                    max="${guide.questions_count || 100}"
                                    value="${guide.max_questions_to_answer || guide.questions_count || ''}"
                                    placeholder="All questions"
                                    class="block w-24 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                >
                                <span class="text-sm text-gray-500">of ${guide.questions_count || 0} questions</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                Leave empty to grade all questions. Set a number to limit AI processing.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            guideInfo.classList.remove('hidden');
            
            // Add event listener for max questions input
            const maxQuestionsInput = document.getElementById('max-questions-input');
            if (maxQuestionsInput) {
                maxQuestionsInput.addEventListener('change', function() {
                    const value = parseInt(this.value);
                    if (value && value > 0) {
                        guide.max_questions_to_answer = value;
                    } else {
                        guide.max_questions_to_answer = null;
                    }
                });
            }
        }
    }
    
    function hideGuideInfo() {
        const guideInfo = document.getElementById('guide-info');
        if (guideInfo) {
            guideInfo.classList.add('hidden');
        }
    }
    
    async function loadSubmissionsForGuide(guideId) {
        const loadingDiv = document.getElementById('submissions-loading');
        
        if (loadingDiv) {
            loadingDiv.textContent = 'Loading submissions for selected guide...';
            loadingDiv.classList.remove('hidden');
        }
        
        selectedSubmissions = [];
        
        try {
            // Load submissions specifically for the selected guide
            const response = await fetch(`/processing/api/submissions?guide_id=${guideId}`);
            const data = await response.json();
            
            if (data.success) {
                const guideSubmissions = data.submissions || [];
                const guideInfo = data.guide || {};
                
                if (guideSubmissions.length > 0) {
                    displaySubmissions(guideSubmissions);
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                            <div class="text-green-600 text-sm mb-2">
                                <p><strong>Found ${guideSubmissions.length} submission(s) for "${guideInfo.title || 'Selected Guide'}"</strong></p>
                                <p>These submissions are linked to the selected marking guide and ready for processing.</p>
                            </div>
                        `;
                    }
                } else {
                    // No submissions found for this guide, show helpful message and option to see all submissions
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                            <div class="text-yellow-600 text-sm mb-4">
                                <p><strong>No submissions found for "${guideInfo.title || 'Selected Guide'}"</strong></p>
                                <p>This marking guide doesn't have any submissions linked to it yet.</p>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-blue-800 mb-2">What you can do:</h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>• Upload new submissions and link them to this guide</li>
                                    <li>• Or <button onclick="loadAllSubmissions()" class="underline hover:text-blue-900">view all your submissions</button> to process with this guide</li>
                                </ul>
                            </div>
                        `;
                    }
                }
            } else {
                throw new Error(data.error || 'Failed to load submissions');
            }
        } catch (error) {
            console.error('Error loading submissions:', error);
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="text-red-600 text-sm">
                        <p>Error loading submissions: ${error.message}</p>
                        <p>Please try again or check the console for more details.</p>
                    </div>
                `;
            }
        }
    }
    
    // Function to load all submissions when no submissions are found for the selected guide
    window.loadAllSubmissions = async function() {
        const loadingDiv = document.getElementById('submissions-loading');
        
        if (loadingDiv) {
            loadingDiv.textContent = 'Loading all your submissions...';
            loadingDiv.classList.remove('hidden');
        }
        
        selectedSubmissions = [];
        
        try {
            // Load all submissions for the user
            const response = await fetch('/processing/api/submissions/all');
            const data = await response.json();
            
            if (data.success) {
                const allSubmissions = data.submissions || [];
                
                if (allSubmissions.length > 0) {
                    displaySubmissions(allSubmissions);
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                            <div class="text-blue-600 text-sm mb-2">
                                <p><strong>Showing all your submissions (${allSubmissions.length} found)</strong></p>
                                <p>These submissions will be processed using the selected marking guide, regardless of their original guide assignment.</p>
                            </div>
                        `;
                    }
                } else {
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                            <div class="text-yellow-600 text-sm">
                                <p>No submissions found in your account.</p>
                                <p>Please upload some submissions first.</p>
                            </div>
                        `;
                    }
                }
            } else {
                throw new Error(data.error || 'Failed to load all submissions');
            }
        } catch (error) {
            console.error('Error loading all submissions:', error);
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="text-red-600 text-sm">
                        <p>Error loading submissions: ${error.message}</p>
                        <p>Please try again or check the console for more details.</p>
                    </div>
                `;
            }
        }
    };
    
    function hideSubmissions() {
        const container = document.getElementById('submissions-container');
        const loadingDiv = document.getElementById('submissions-loading');
        
        if (container) {
            container.classList.add('hidden');
        }
        
        if (loadingDiv) {
            loadingDiv.textContent = 'Please select a marking guide first';
            loadingDiv.classList.remove('hidden');
        }
        
        selectedSubmissions = [];
        updateSelectedCount();
    }
    
    function displaySubmissions(submissions) {
        const container = document.getElementById('submissions-container');
        const loadingDiv = document.getElementById('submissions-loading');
        const submissionsList = document.getElementById('submissions-list');
        
        if (!container || !submissionsList) {
            console.error('Submissions container elements not found');
            return;
        }
        
        if (submissions.length === 0) {
            if (loadingDiv) {
                loadingDiv.textContent = 'No submissions found. Please upload submissions first.';
            }
            container.classList.add('hidden');
            return;
        }
        
        // Hide loading and show container
        if (loadingDiv) {
            loadingDiv.classList.add('hidden');
        }
        
        container.classList.remove('hidden');
        container.style.display = 'block';
        
        // Create card-based layout for submissions
        const submissionsHtml = submissions.map(submission => {
            const statusColor = getStatusColor(submission.processing_status);
            const fileSize = submission.file_size ? (submission.file_size / 1024 / 1024).toFixed(1) : '0';
            
            return `
                <div class="border border-gray-200 rounded-md p-3 hover:bg-gray-50">
                    <label class="flex items-start space-x-3 cursor-pointer">
                        <input type="checkbox" 
                               name="submission_ids" 
                               value="${submission.id}" 
                               class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded submission-checkbox">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 truncate">
                                ${submission.filename}
                            </div>
                            ${submission.student_name ? `
                            <div class="text-xs text-gray-500">
                                ${submission.student_name}
                            </div>
                            ` : ''}
                            <div class="text-xs text-gray-400">
                                ${submission.file_type ? submission.file_type.toUpperCase() : 'FILE'} • ${fileSize}MB
                            </div>
                            <div class="text-xs">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                    ${submission.processing_status ? submission.processing_status.charAt(0).toUpperCase() + submission.processing_status.slice(1) : 'Ready'}
                                </span>
                            </div>
                        </div>
                    </label>
                </div>
            `;
        }).join('');
        
        submissionsList.innerHTML = submissionsHtml;
        
        // Add event listeners
        setupSubmissionEventListeners();
        updateSelectedCount();
    }
    
    function getStatusColor(status) {
        switch(status) {
            case 'completed':
                return 'bg-green-100 text-green-800';
            case 'processing':
                return 'bg-yellow-100 text-yellow-800';
            case 'failed':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }
    
    function setupSubmissionEventListeners() {
        // Checkbox event listeners for the new card-based layout
        document.querySelectorAll('.submission-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const submissionId = this.value;
                const index = selectedSubmissions.indexOf(submissionId);
                
                if (this.checked && index === -1) {
                    selectedSubmissions.push(submissionId);
                } else if (!this.checked && index > -1) {
                    selectedSubmissions.splice(index, 1);
                }
                
                updateSelectedCount();
                updateProcessingButton();
            });
        });
        
        // Select all/clear all handlers
        const selectAllBtn = document.getElementById('select-all-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        
        if (selectAllBtn) {
            selectAllBtn.removeEventListener('click', selectAllSubmissions); // Remove existing listener
            selectAllBtn.addEventListener('click', selectAllSubmissions);
        }
        if (clearAllBtn) {
            clearAllBtn.removeEventListener('click', clearAllSubmissions); // Remove existing listener
            clearAllBtn.addEventListener('click', clearAllSubmissions);
        }
    }
    
    function toggleSubmissionSelection(submissionId) {
        const index = selectedSubmissions.indexOf(submissionId);
        const checkbox = document.querySelector(`input[data-submission-id="${submissionId}"]`);
        
        if (index > -1) {
            selectedSubmissions.splice(index, 1);
            if (checkbox) checkbox.checked = false;
        } else {
            selectedSubmissions.push(submissionId);
            if (checkbox) checkbox.checked = true;
        }
        
        updateSelectedCount();
        updateProcessingButton();
    }
    
    function selectAllSubmissions() {
        selectedSubmissions = [];
        document.querySelectorAll('.submission-checkbox').forEach(checkbox => {
            const submissionId = checkbox.value; // Use value instead of dataset.submissionId
            selectedSubmissions.push(submissionId);
            checkbox.checked = true;
        });
        updateSelectedCount();
        updateProcessingButton();
    }
    
    function clearAllSubmissions() {
        selectedSubmissions = [];
        document.querySelectorAll('.submission-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount();
        updateProcessingButton();
    }
    
    function updateSelectedCount() {
        const selectedCount = document.getElementById('selected-count');
        if (selectedCount) {
            const count = selectedSubmissions.length;
            selectedCount.textContent = `${count} submission${count !== 1 ? 's' : ''} selected`;
        }
    }
    
    // Functions for guide-specific selection
    window.selectAllInGuide = function(guideKey) {
        const checkboxes = document.querySelectorAll(`input[data-guide="${guideKey}"]`);
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                const submissionId = checkbox.value;
                if (!selectedSubmissions.includes(submissionId)) {
                    selectedSubmissions.push(submissionId);
                }
            }
        });
        updateSelectedCount();
        updateProcessingButton();
    };
    
    window.clearAllInGuide = function(guideKey) {
        const checkboxes = document.querySelectorAll(`input[data-guide="${guideKey}"]`);
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                checkbox.checked = false;
                const submissionId = checkbox.value;
                const index = selectedSubmissions.indexOf(submissionId);
                if (index > -1) {
                    selectedSubmissions.splice(index, 1);
                }
            }
        });
        updateSelectedCount();
        updateProcessingButton();
    };
    
    // Enhanced event listeners for grouped submissions
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('submission-checkbox')) {
            const submissionId = e.target.value;
            const index = selectedSubmissions.indexOf(submissionId);
            
            if (e.target.checked && index === -1) {
                selectedSubmissions.push(submissionId);
            } else if (!e.target.checked && index > -1) {
                selectedSubmissions.splice(index, 1);
            }
            
            updateSelectedCount();
            updateProcessingButton();
        }
    });
    
    function updateProcessingButton() {
        const hasGuide = selectedGuide !== null;
        const hasSubmissions = selectedSubmissions.length > 0;
        
        startButton.disabled = !(hasGuide && hasSubmissions);
        
        if (!statusDiv) {
            console.error('Status div element not found');
            return;
        }
        
        if (hasGuide && hasSubmissions) {
            statusDiv.innerHTML = `<div class="text-green-600">Ready to process ${selectedSubmissions.length} submission(s) with selected marking guide</div>`;
        } else if (!hasGuide) {
            statusDiv.innerHTML = '<div class="text-yellow-600">Please select a marking guide</div>';
        } else if (!hasSubmissions) {
            statusDiv.innerHTML = '<div class="text-yellow-600">Please select at least one submission</div>';
        }
    }
    
    async function startEnhancedProcessing() {
        startButton.disabled = true;
        startButton.textContent = 'Processing...';
        
        if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-blue-600">Starting enhanced processing pipeline...</div>';
        }
        
        if (progressSection) {
            progressSection.classList.remove('hidden');
        }
        
        try {
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            const maxQuestionsInput = document.getElementById('max-questions-input');
            const maxQuestionsToAnswer = maxQuestionsInput && maxQuestionsInput.value ? 
                parseInt(maxQuestionsInput.value) : null;
            
            const requestData = {
                marking_guide_id: selectedGuide,
                submission_ids: selectedSubmissions
            };
            
            if (maxQuestionsToAnswer && maxQuestionsToAnswer > 0) {
                requestData.max_questions_to_answer = maxQuestionsToAnswer;
            }
            

            
            const response = await fetch('/api/enhanced-processing/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                monitorProgress(data.task_id);
            } else {
                throw new Error(data.error || 'Processing failed to start');
            }
        } catch (error) {
            console.error('Error starting processing:', error);
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
            }
            resetProcessingButton();
        }
    }
    
    function monitorProgress(taskId) {
        progressRetryCount = 0;
        
        function checkProgress() {
            fetch(`/api/enhanced-processing/progress/${taskId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Unknown error');
                    }
                    
                    progressRetryCount = 0;
                    updateProgressDisplay(data);
                    
                    if (data.status === 'completed') {
                        clearProgressPolling();
                        showResults(data.results);
                        resetProcessingButton();
                    } else if (data.status === 'failed') {
                        clearProgressPolling();
                        if (statusDiv) {
                            statusDiv.innerHTML = `<div class="text-red-600">Processing failed: ${data.message || data.error || 'Unknown error'}</div>`;
                        }
                        resetProcessingButton();
                    } else {
                        const pollInterval = Math.min(2000 + (progressRetryCount * 1000), 5000);
                        progressPollingInterval = setTimeout(checkProgress, pollInterval);
                    }
                })
                .catch(error => {
                    console.error('Progress monitoring error:', error);
                    progressRetryCount++;
                    
                    if (progressRetryCount >= MAX_PROGRESS_RETRIES) {
                        clearProgressPolling();
                        if (statusDiv) {
                            statusDiv.innerHTML = `<div class="text-red-600">Error monitoring progress: ${error.message}. Please refresh the page and try again.</div>`;
                        }
                        resetProcessingButton();
                    } else {
                        const retryDelay = Math.min(1000 * Math.pow(2, progressRetryCount), 10000);
                        progressPollingInterval = setTimeout(checkProgress, retryDelay);
                    }
                });
        }
        
        checkProgress();
    }
    
    function clearProgressPolling() {
        if (progressPollingInterval) {
            clearTimeout(progressPollingInterval);
            progressPollingInterval = null;
        }
    }
    
    function resetProcessingButton() {
        startButton.disabled = false;
        startButton.textContent = 'Start Enhanced Processing';
        updateProcessingButton();
    }
    
    function updateProgressDisplay(data) {
        const progressContainer = document.getElementById('progress-container');
        
        if (!progressContainer) {
            console.error('Progress container element not found');
            return;
        }
        
        const progress = data.progress || 0;
        const message = data.message || 'Processing...';
        const currentFile = data.current_file || '';
        const results = data.results || {};
        
        progressContainer.innerHTML = `
            <div class="mb-6">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>${message}</span>
                    <span>${Math.round(progress)}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                </div>
            </div>
            
            ${currentFile ? `
                <div class="mb-4 text-sm text-gray-600">
                    <strong>Current file:</strong> ${currentFile}
                </div>
            ` : ''}
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="text-lg font-semibold text-blue-600">${results.total_count || 0}</div>
                    <div class="text-xs text-blue-800">Total Submissions</div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <div class="text-lg font-semibold text-green-600">${results.successful_count || 0}</div>
                    <div class="text-xs text-green-800">Successful</div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <div class="text-lg font-semibold text-red-600">${results.failed_count || 0}</div>
                    <div class="text-xs text-red-800">Failed</div>
                </div>
            </div>
        `;
    }
    
    function showResults(results) {
        const resultsContainer = document.getElementById('results-container');
        
        if (!resultsContainer) {
            console.error('Results container element not found');
            return;
        }
        
        resultsSection.classList.remove('hidden');
        
        const details = results.details || [];
        const successfulResults = details.filter(r => r.success);
        const failedResults = details.filter(r => !r.success);
        
        resultsContainer.innerHTML = `
            <div class="space-y-6">
                <!-- Summary Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-blue-900">Total Processed</h3>
                        <p class="text-2xl font-bold text-blue-600">${results.total_count || 0}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-green-900">Successful</h3>
                        <p class="text-2xl font-bold text-green-600">${results.successful_count || 0}</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-red-900">Failed</h3>
                        <p class="text-2xl font-bold text-red-600">${results.failed_count || 0}</p>
                    </div>
                </div>
                
                <!-- Successful Results -->
                ${successfulResults.length > 0 ? `
                    <div>
                        <h3 class="text-lg font-medium text-green-900 mb-3">Successfully Processed</h3>
                        <div class="space-y-2">
                            ${successfulResults.map(result => `
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <span class="font-medium">${result.filename}</span>
                                    <span class="text-green-600">Score: ${result.score || 'N/A'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Failed Results -->
                ${failedResults.length > 0 ? `
                    <div>
                        <h3 class="text-lg font-medium text-red-900 mb-3">Failed to Process</h3>
                        <div class="space-y-2">
                            ${failedResults.map(result => `
                                <div class="p-3 bg-red-50 rounded-lg">
                                    <div class="font-medium text-red-900">${result.filename}</div>
                                    <div class="text-sm text-red-700">${result.error || 'Unknown error'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Action Buttons -->
                <div class="flex space-x-4">
                    <a href="/results" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        View Detailed Results
                    </a>
                    <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        Process More Submissions
                    </button>
                </div>
            </div>
        `;
    }
});
</script>
{% endblock %}