{% extends "layout.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Hidden CSRF Token -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Enhanced AI Processing Pipeline</h1>
        <p class="mt-2 text-lg text-gray-600">
            Complete LLM-driven workflow for marking guide processing, submission mapping, and intelligent grading
        </p>
    </div>

    <!-- Processing Steps Overview -->
    <div class="mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Pipeline</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">1. Guide Processing</h3>
                    <p class="text-sm text-gray-500">LLM extracts structured questions and answers from marking guides</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">2. Submission Mapping</h3>
                    <p class="text-sm text-gray-500">OCR + LLM intelligently maps student answers to guide questions</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">3. AI Grading</h3>
                    <p class="text-sm text-gray-500">LLM grades with max_questions_to_answer logic and detailed feedback</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Processing Form -->
    <form id="enhanced-processing-form" class="space-y-8">
        <!-- Select Marking Guide Section -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Select Marking Guide</h2>
            <div class="mb-4">
                <select id="marking-guide-select" name="marking_guide_id" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Loading marking guides...</option>
                </select>
            </div>
            <div id="guide-info" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
                <div id="guide-details"></div>
            </div>
        </div>

        <!-- Select Submissions Section -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Select Submissions</h2>
            <div id="submissions-loading" class="text-gray-500 mb-4">Please select a marking guide first</div>
            <div id="submissions-container" class="hidden">
                <div class="mb-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Select submissions to process:</span>
                        <div class="space-x-2">
                            <button type="button" id="select-all-btn" class="text-sm text-blue-600 hover:text-blue-800">Select All</button>
                            <button type="button" id="clear-all-btn" class="text-sm text-gray-600 hover:text-gray-800">Clear All</button>
                        </div>
                    </div>
                </div>
                <div id="submissions-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Submissions will be loaded here -->
                </div>
                <div id="selected-count" class="mt-4 text-sm text-gray-600">
                    0 submissions selected
                </div>
            </div>
        </div>
    </form>

    <!-- Processing Status Section -->
    <div class="mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Status</h2>
            <div id="processing-status" class="mb-4">
                <div class="text-gray-600">Ready to begin processing...</div>
            </div>
            
            <!-- Start Processing Button -->
            <button id="start-processing" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Start Enhanced Processing
            </button>
        </div>
    </div>

    <!-- Progress Section -->
    <div id="progress-section" class="mb-8 hidden">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Progress</h2>
            <div id="progress-container">
                <!-- Progress will be populated here -->
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden">
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Processing Results</h2>
            <div id="results-container">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedGuide = null;
    let selectedSubmissions = [];
    
    const startButton = document.getElementById('start-processing');
    const statusDiv = document.getElementById('processing-status');
    const progressSection = document.getElementById('progress-section');
    const resultsSection = document.getElementById('results-section');
    
    // Initialize the page state
    initializePage();
    
    // Load marking guides only - submissions will load when guide is selected
    loadMarkingGuides();
    
    function initializePage() {
        // Clear any existing selections first
        selectedSubmissions = [];
        selectedGuide = null;
        
        // Simply hide the submissions container instead of removing it
        const container = document.getElementById('submissions-container');
        const loadingDiv = document.getElementById('submissions-loading');
        
        if (container) {
            container.classList.add('hidden');
            container.style.display = 'none';
            console.log('Submissions container hidden');
        }
        
        if (loadingDiv) {
            loadingDiv.textContent = 'Please select a marking guide first';
            loadingDiv.classList.remove('hidden');
        }
        
        // Initialize processing button state
        updateProcessingButton();
        
        console.log('Page initialized - submissions container hidden');
    }
    
    startButton.addEventListener('click', function() {
        if (selectedGuide && selectedSubmissions.length > 0) {
            startEnhancedProcessing();
        }
    });
    
    function loadMarkingGuides() {
        fetch('/refactored/api/marking-guides')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateMarkingGuideSelect(data.guides || []);
                } else {
                    throw new Error(data.error || 'Failed to load marking guides');
                }
            })
            .catch(error => {
                console.error('Error loading marking guides:', error);
                const select = document.getElementById('marking-guide-select');
                if (select) {
                    select.innerHTML = '<option value="">Error loading marking guides</option>';
                }
            });
    }
    

    
    function populateMarkingGuideSelect(guides) {
        const select = document.getElementById('marking-guide-select');
        
        if (!select) {
            console.error('Marking guide select element not found');
            return;
        }
        
        if (guides.length === 0) {
            select.innerHTML = '<option value="">No marking guides found. Please upload a marking guide first.</option>';
            return;
        }
        
        const optionsHtml = guides.map(guide => 
            `<option value="${guide.id}">${guide.title || guide.filename} (${guide.questions_count || 0} questions)</option>`
        ).join('');
        
        select.innerHTML = `<option value="">Select a marking guide...</option>${optionsHtml}`;
        
        // Add change handler for guide selection
        select.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue) {
                selectedGuide = selectedValue;
                showGuideInfo(guides.find(g => g.id == selectedValue));
                // Load submissions for the selected guide
                loadSubmissionsForGuide(selectedValue);
            } else {
                selectedGuide = null;
                hideGuideInfo();
                hideSubmissions();
            }
            updateProcessingButton();
        });
    }
    
    function showGuideInfo(guide) {
        const guideInfo = document.getElementById('guide-info');
        const guideDetails = document.getElementById('guide-details');
        
        if (guideInfo && guideDetails && guide) {
            guideDetails.innerHTML = `
                <h4 class="font-medium text-gray-900 mb-4">${guide.title || guide.filename || 'Untitled Guide'}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="text-sm text-gray-600 space-y-2">
                        <p><strong>Questions extracted:</strong> ${guide.questions_count || 0}</p>
                        <p><strong>Total marks:</strong> ${guide.total_marks || 0}</p>
                        <p><strong>Created:</strong> ${new Date(guide.created_at).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> Active</p>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label for="max-questions-input" class="block text-sm font-medium text-gray-700 mb-1">
                                Max Questions to Answer
                            </label>
                            <div class="flex items-center space-x-2">
                                <input 
                                    type="number" 
                                    id="max-questions-input" 
                                    min="1" 
                                    max="${guide.questions_count || 100}"
                                    value="${guide.max_questions_to_answer || guide.questions_count || ''}"
                                    placeholder="All questions"
                                    class="block w-24 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                >
                                <span class="text-sm text-gray-500">of ${guide.questions_count || 0} questions</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                Leave empty to grade all questions. Set a number to limit AI processing.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            guideInfo.classList.remove('hidden');
            
            // Add event listener for max questions input
            const maxQuestionsInput = document.getElementById('max-questions-input');
            if (maxQuestionsInput) {
                maxQuestionsInput.addEventListener('change', function() {
                    const value = parseInt(this.value);
                    if (value && value > 0) {
                        guide.max_questions_to_answer = value;
                        console.log(`Max questions to answer set to: ${value}`);
                    } else {
                        guide.max_questions_to_answer = null;
                        console.log('Max questions to answer set to: All questions');
                    }
                });
            }
        }
    }
    
    function hideGuideInfo() {
        const guideInfo = document.getElementById('guide-info');
        if (guideInfo) {
            guideInfo.classList.add('hidden');
        }
    }
    
    function loadSubmissionsForGuide(guideId) {
        console.log(`=== Loading submissions for guide ID: ${guideId} ===`);
        
        const loadingDiv = document.getElementById('submissions-loading');
        const submissionsContainer = document.getElementById('submissions-container');
        
        console.log('Loading div found:', !!loadingDiv);
        console.log('Submissions container found:', !!submissionsContainer);
        
        if (loadingDiv) {
            loadingDiv.textContent = 'Loading submissions...';
            loadingDiv.classList.remove('hidden');
        }
        
        // Restore the submissions container if it was removed
        if (!submissionsContainer && window.originalSubmissionsContainer) {
            console.log('Restoring submissions container from stored HTML');
            const submissionsSection = loadingDiv ? loadingDiv.parentNode : null;
            if (submissionsSection) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = window.originalSubmissionsContainer;
                const restoredContainer = tempDiv.firstChild;
                
                if (loadingDiv) {
                    loadingDiv.parentNode.insertBefore(restoredContainer, loadingDiv.nextSibling);
                    console.log('Submissions container restored to DOM');
                } else {
                    submissionsSection.appendChild(restoredContainer);
                    console.log('Submissions container restored to DOM (fallback)');
                }
            }
        } else if (submissionsContainer) {
            console.log('Submissions container already exists in DOM');
        }
        
        // Clear previous selections
        selectedSubmissions = [];
        
        // Load all user submissions and show them (they will be processed with the selected guide)
        console.log('Loading all user submissions');
        const allApiUrl = '/refactored/api/submissions';
        console.log('Making API call to:', allApiUrl);
        
        fetch(allApiUrl)
            .then(response => {
                console.log('API Response status:', response.status);
                console.log('API Response ok:', response.ok);
                return response.json();
            })
            .then(data => {
                console.log('API Response data:', data);
                
                if (data.success) {
                    const allSubmissions = data.submissions || [];
                    console.log(`Found ${allSubmissions.length} total user submissions`);
                    
                    if (allSubmissions.length > 0) {
                        console.log('Displaying all submissions');
                        displaySubmissions(allSubmissions);
                        if (loadingDiv) {
                            loadingDiv.innerHTML = `
                                <div class="text-blue-600 text-sm mb-2">
                                    <p><strong>Showing all your submissions (${allSubmissions.length} found)</strong></p>
                                    <p>These submissions will be processed using the selected marking guide.</p>
                                </div>
                            `;
                        }
                    } else {
                        console.log('No submissions found');
                        if (loadingDiv) {
                            loadingDiv.innerHTML = `
                                <div class="text-yellow-600 text-sm">
                                    <p>No submissions found in your account.</p>
                                    <p>Please upload some submissions first.</p>
                                </div>
                            `;
                        }
                    }
                } else {
                    throw new Error(data.error || 'Failed to load submissions');
                }
            })
            .catch(error => {
                console.error('Error loading submissions:', error);
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <div class="text-red-600 text-sm">
                            <p>Error loading submissions: ${error.message}</p>
                            <p>Please try again or check the console for more details.</p>
                        </div>
                    `;
                }
            });
        
        function loadAllUserSubmissions() {
            console.log('Loading all user submissions as fallback');
            const allApiUrl = '/refactored/api/submissions';
            console.log('Making all submissions API call to:', allApiUrl);
            
            fetch(allApiUrl)
                .then(response => {
                    console.log('All submissions API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('All submissions API Response data:', data);
                    
                    if (data.success) {
                        const submissions = data.submissions || [];
                        console.log(`Found ${submissions.length} total user submissions`);
                        
                        if (submissions.length > 0) {
                            displaySubmissions(submissions);
                            // Update loading message to explain what's shown
                            if (loadingDiv) {
                                loadingDiv.innerHTML = `
                                    <div class="text-blue-600 text-sm mb-2">
                                        <p><strong>Showing all your submissions (${submissions.length} found)</strong></p>
                                        <p>These submissions will be processed using the selected marking guide.</p>
                                        <p class="text-xs text-gray-500 mt-1">Note: Submissions are not pre-linked to this guide, but can be processed with it.</p>
                                    </div>
                                `;
                            }
                        } else {
                            if (loadingDiv) {
                                loadingDiv.innerHTML = `
                                    <div class="text-yellow-600 text-sm">
                                        <p>No submissions found in your account.</p>
                                        <p>Please upload some submissions first.</p>
                                    </div>
                                `;
                            }
                        }
                    } else {
                        throw new Error(data.error || 'Failed to load submissions');
                    }
                })
                .catch(error => {
                    console.error('Error loading all submissions:', error);
                    if (loadingDiv) {
                        loadingDiv.innerHTML = `
                            <div class="text-red-600 text-sm">
                                <p>Error loading submissions: ${error.message}</p>
                                <p>Please try again or check the console for more details.</p>
                            </div>
                        `;
                    }
                });
        }
    }
    
    function hideSubmissions() {
        const container = document.getElementById('submissions-container');
        const loadingDiv = document.getElementById('submissions-loading');
        
        if (container) {
            container.classList.add('hidden');
        }
        
        if (loadingDiv) {
            loadingDiv.textContent = 'Please select a marking guide first';
            loadingDiv.classList.remove('hidden');
        }
        
        // Clear selections
        selectedSubmissions = [];
        updateSelectedCount();
    }
    
    function displaySubmissions(submissions) {
        const container = document.getElementById('submissions-container');
        const loadingDiv = document.getElementById('submissions-loading');
        const submissionsList = document.getElementById('submissions-list');
        const selectedCount = document.getElementById('selected-count');
        
        if (!container || !submissionsList) {
            console.error('Submissions container elements not found');
            return;
        }
        
        if (submissions.length === 0) {
            if (loadingDiv) {
                loadingDiv.textContent = 'No submissions found. Please upload submissions first.';
            }
            container.classList.add('hidden');
            return;
        }
        
        // Hide loading and show container
        if (loadingDiv) {
            loadingDiv.classList.add('hidden');
        }
        
        // Force show the container with multiple methods
        container.classList.remove('hidden');
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.opacity = '1';
        
        console.log('=== CONTAINER VISIBILITY DEBUG ===');
        console.log('Submissions container should now be visible');
        console.log('Container classes:', container.className);
        console.log('Container style.display:', container.style.display);
        console.log('Container offsetHeight:', container.offsetHeight);
        console.log('Container offsetWidth:', container.offsetWidth);
        console.log('Container is hidden:', container.classList.contains('hidden'));
        console.log('Container computed style:', window.getComputedStyle(container).display);
        console.log('=== END DEBUG ===');
        
        const submissionsHtml = submissions.map(submission => `
            <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer submission-item" 
                 data-submission-id="${submission.id}">
                <input type="checkbox" class="submission-checkbox mr-3" data-submission-id="${submission.id}">
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${submission.filename}</div>
                    <div class="text-sm text-gray-500">
                        Status: ${submission.processing_status || 'Ready'} | 
                        Uploaded: ${new Date(submission.created_at).toLocaleDateString()}
                    </div>
                </div>
            </div>
        `).join('');
        
        submissionsList.innerHTML = submissionsHtml;
        
        // Add event listeners for checkboxes and items
        document.querySelectorAll('.submission-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                toggleSubmissionSelection(this.dataset.submissionId);
            });
        });
        
        document.querySelectorAll('.submission-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = this.querySelector('.submission-checkbox');
                    checkbox.checked = !checkbox.checked;
                    toggleSubmissionSelection(checkbox.dataset.submissionId);
                }
            });
        });
        
        // Add select all/clear all handlers
        const selectAllBtn = document.getElementById('select-all-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', selectAllSubmissions);
        }
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', clearAllSubmissions);
        }
        
        updateSelectedCount();
    }
    

    
    function toggleSubmissionSelection(submissionId) {
        const index = selectedSubmissions.indexOf(submissionId);
        const checkbox = document.querySelector(`input[data-submission-id="${submissionId}"]`);
        
        if (index > -1) {
            // Deselect
            selectedSubmissions.splice(index, 1);
            if (checkbox) checkbox.checked = false;
        } else {
            // Select
            selectedSubmissions.push(submissionId);
            if (checkbox) checkbox.checked = true;
        }
        
        updateSelectedCount();
        updateProcessingButton();
    }
    
    function selectAllSubmissions() {
        selectedSubmissions = [];
        document.querySelectorAll('.submission-checkbox').forEach(checkbox => {
            const submissionId = checkbox.dataset.submissionId;
            selectedSubmissions.push(submissionId);
            checkbox.checked = true;
        });
        updateSelectedCount();
        updateProcessingButton();
    }
    
    function clearAllSubmissions() {
        selectedSubmissions = [];
        document.querySelectorAll('.submission-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount();
        updateProcessingButton();
    }
    
    function updateSelectedCount() {
        const selectedCount = document.getElementById('selected-count');
        if (selectedCount) {
            const count = selectedSubmissions.length;
            selectedCount.textContent = `${count} submission${count !== 1 ? 's' : ''} selected`;
        }
    }
    
    function updateProcessingButton() {
        const hasGuide = selectedGuide !== null;
        const hasSubmissions = selectedSubmissions.length > 0;
        
        startButton.disabled = !(hasGuide && hasSubmissions);
        
        if (!statusDiv) {
            console.error('Status div element not found');
            return;
        }
        
        if (hasGuide && hasSubmissions) {
            statusDiv.innerHTML = `<div class="text-green-600">Ready to process ${selectedSubmissions.length} submission(s) with selected marking guide</div>`;
        } else if (!hasGuide) {
            statusDiv.innerHTML = '<div class="text-yellow-600">Please select a marking guide</div>';
        } else if (!hasSubmissions) {
            statusDiv.innerHTML = '<div class="text-yellow-600">Please select at least one submission</div>';
        }
    }
    
    function startEnhancedProcessing() {
        startButton.disabled = true;
        startButton.textContent = 'Processing...';
        
        if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-blue-600">Starting enhanced processing pipeline...</div>';
        }
        
        if (progressSection) {
            progressSection.classList.remove('hidden');
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        // Get max questions to answer value
        const maxQuestionsInput = document.getElementById('max-questions-input');
        const maxQuestionsToAnswer = maxQuestionsInput && maxQuestionsInput.value ? 
            parseInt(maxQuestionsInput.value) : null;
        
        // Prepare request data
        const requestData = {
            marking_guide_id: selectedGuide,
            submission_ids: selectedSubmissions
        };
        
        // Add max_questions_to_answer if specified
        if (maxQuestionsToAnswer && maxQuestionsToAnswer > 0) {
            requestData.max_questions_to_answer = maxQuestionsToAnswer;
        }
        
        console.log('Starting enhanced processing with data:', requestData);
        
        // Start the processing
        fetch('/api/enhanced-processing/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                monitorProgress(data.task_id);
            } else {
                if (statusDiv) {
                    statusDiv.innerHTML = `<div class="text-red-600">Error: ${data.error}</div>`;
                }
                startButton.disabled = false;
                startButton.textContent = 'Start Enhanced Processing';
            }
        })
        .catch(error => {
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
            }
            startButton.disabled = false;
            startButton.textContent = 'Start Enhanced Processing';
        });
    }
    
    function monitorProgress(taskId) {
        const progressContainer = document.getElementById('progress-container');
        
        function checkProgress() {
            fetch(`/api/enhanced-processing/progress/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgressDisplay(data);
                    
                    if (data.status === 'completed') {
                        showResults(data.results);
                        startButton.disabled = false;
                        startButton.textContent = 'Start Enhanced Processing';
                        updateProcessingButton();
                    } else if (data.status === 'failed') {
                        if (statusDiv) {
                            statusDiv.innerHTML = `<div class="text-red-600">Processing failed: ${data.error}</div>`;
                        }
                        startButton.disabled = false;
                        startButton.textContent = 'Start Enhanced Processing';
                        updateProcessingButton();
                    } else {
                        // Poll more frequently for real-time updates (every 500ms for smooth progress)
                        setTimeout(checkProgress, 500);
                    }
                })
                .catch(error => {
                    if (statusDiv) {
                        statusDiv.innerHTML = `<div class="text-red-600">Error monitoring progress: ${error.message}</div>`;
                    }
                    startButton.disabled = false;
                    startButton.textContent = 'Start Enhanced Processing';
                    updateProcessingButton();
                });
        }
        
        checkProgress();
    }
    
    function updateProgressDisplay(data) {
        const progressContainer = document.getElementById('progress-container');
        
        if (!progressContainer) {
            console.error('Progress container element not found');
            return;
        }
        
        const progress = data.progress || 0;
        const currentStep = data.current_step || 'Initializing';
        
        progressContainer.innerHTML = `
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>${currentStep}</span>
                    <span>${progress}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                </div>
            </div>
            <div class="text-sm text-gray-600">
                ${data.message || 'Processing...'}
            </div>
        `;
    }
    
    function showResults(results) {
        const resultsContainer = document.getElementById('results-container');
        
        // Check if the element exists before trying to set innerHTML
        if (!resultsContainer) {
            console.error('Results container element not found');
            return;
        }
        
        resultsSection.classList.remove('hidden');
        
        resultsContainer.innerHTML = `
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-medium text-blue-900">Guides Processed</h3>
                        <p class="text-2xl font-bold text-blue-600">${results.guides_processed || 0}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-medium text-green-900">Submissions Mapped</h3>
                        <p class="text-2xl font-bold text-green-600">${results.submissions_mapped || 0}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-medium text-purple-900">Grades Generated</h3>
                        <p class="text-2xl font-bold text-purple-600">${results.grades_generated || 0}</p>
                    </div>
                </div>
                <div class="mt-6">
                    <a href="/results" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        View Detailed Results
                    </a>
                </div>
            </div>
        `;
    }
});
</script>
{% endblock %}