{% extends "layout.html" %}

{% block title %}LLM Training - Exam Grader{% endblock %}

{% block extra_css %}
<style>
    .training-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .training-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 10px;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .document-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .document-card {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        background: #f9fafb;
        transition: all 0.2s;
    }
    
    .document-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .document-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }
    
    .document-name {
        font-weight: 600;
        color: #1f2937;
        word-break: break-word;
    }
    
    .document-actions {
        display: flex;
        gap: 8px;
    }
    
    .document-meta {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 8px;
    }
    
    .document-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
    }
    
    .tag {
        background: #dbeafe;
        color: #1e40af;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .dataset-selector {
        margin-bottom: 20px;
    }
    
    .dataset-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .dataset-tab {
        padding: 8px 16px;
        border: none;
        background: none;
        color: #6b7280;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    
    .dataset-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    
    .dataset-tab:hover {
        color: #1f2937;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
    }
    
    .btn-danger:hover {
        background: #dc2626;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 0.875rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 8px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 16px;
    }
    
    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .close-btn:hover {
        color: #1f2937;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: #1f2937;
    }
    
    .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .checkbox-group {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 8px;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: #f3f4f6;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 4px;
    }

    /* Training Job Styles */
    .training-job {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        background: #f9fafb;
        transition: all 0.2s;
    }

    .training-job:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .job-name {
        font-weight: 600;
        color: #1f2937;
        font-size: 1.1rem;
    }

    .job-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-preparing { background: #dbeafe; color: #1e40af; }
    .status-training { background: #fde68a; color: #92400e; }
    .status-evaluating { background: #e0e7ff; color: #3730a3; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-failed { background: #fee2e2; color: #991b1b; }
    .status-cancelled { background: #f3f4f6; color: #4b5563; }

    .job-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .progress-bar {
        background: #e5e7eb;
        border-radius: 4px;
        height: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }

    .progress-fill {
        background: #3b82f6;
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .job-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    /* Report Styles */
    .report-item {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        background: #f9fafb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .report-info h4 {
        margin: 0 0 4px 0;
        font-weight: 600;
        color: #1f2937;
    }

    .report-info p {
        margin: 0;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .report-actions {
        display: flex;
        gap: 8px;
    }

    /* Modal Enhancements */
    .modal-content.large {
        max-width: 700px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
    }

    .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .config-section {
        background: #f9fafb;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .config-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="training-container">
    <div class="section-header">
        <h1 class="section-title">LLM Training & Fine-tuning</h1>
    </div>

    <!-- Document Management Section -->
    <div class="training-section">
        <div class="section-header">
            <h2 class="section-title">Document Management</h2>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="showCreateDatasetModal()">
                    <i class="fas fa-plus"></i> Create Dataset
                </button>
                <button class="btn btn-secondary" onclick="showUploadModal()">
                    <i class="fas fa-upload"></i> Upload Documents
                </button>
                <button class="btn btn-secondary" onclick="documentManager.showDatasetManager()">
                    <i class="fas fa-cog"></i> Manage Datasets
                </button>
            </div>
        </div>

        <!-- Dataset Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-documents">0</div>
                <div class="stat-label">Total Documents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-datasets">0</div>
                <div class="stat-label">Datasets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-words">0</div>
                <div class="stat-label">Total Words</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-size">0 MB</div>
                <div class="stat-label">Total Size</div>
            </div>
        </div>

        <!-- Dataset Selector -->
        <div class="dataset-selector">
            <div class="dataset-tabs" id="dataset-tabs">
                <button class="dataset-tab active" data-dataset="all">All Documents</button>
                <button class="dataset-tab" data-dataset="unassigned">Unassigned</button>
            </div>
        </div>

        <!-- Document Grid -->
        <div class="document-grid" id="document-grid">
            <!-- Documents will be loaded here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-state-icon">📄</div>
            <h3>No documents found</h3>
            <p>Upload some documents to get started with training your models.</p>
            <button class="btn btn-primary" onclick="showUploadModal()">
                <i class="fas fa-upload"></i> Upload Documents
            </button>
        </div>
    </div>

    <!-- Training Management Section -->
    <div class="training-section">
        <div class="section-header">
            <h2 class="section-title">Model Training</h2>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="documentManager.refreshModels()">
                    <i class="fas fa-sync-alt"></i> Refresh Models
                </button>
                <button class="btn btn-secondary" onclick="documentManager.testFunctionality()">
                    <i class="fas fa-vial"></i> Test
                </button>
                <button class="btn btn-primary" onclick="showCreateTrainingModal()">
                    <i class="fas fa-play"></i> Start Training
                </button>
            </div>
        </div>

        <!-- Training Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-jobs">0</div>
                <div class="stat-label">Total Jobs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="running-jobs">0</div>
                <div class="stat-label">Running</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completed-jobs">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failed-jobs">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <!-- Training Jobs List -->
        <div id="training-jobs-container">
            <div class="empty-state" id="training-empty-state">
                <div class="empty-state-icon">🤖</div>
                <h3>No training jobs</h3>
                <p>Create your first training job to start fine-tuning models.</p>
                <button class="btn btn-primary" onclick="showCreateTrainingModal()">
                    <i class="fas fa-play"></i> Start Training
                </button>
            </div>
        </div>
    </div>

    <!-- Reports Section -->
    <div class="training-section">
        <div class="section-header">
            <h2 class="section-title">Training Reports</h2>
            <button class="btn btn-primary" onclick="showGenerateReportModal()">
                <i class="fas fa-chart-bar"></i> Generate Report
            </button>
        </div>

        <!-- Reports List -->
        <div id="reports-container">
            <div class="empty-state" id="reports-empty-state">
                <div class="empty-state-icon">📊</div>
                <h3>No reports generated</h3>
                <p>Generate reports to analyze your training results.</p>
                <button class="btn btn-primary" onclick="showGenerateReportModal()">
                    <i class="fas fa-chart-bar"></i> Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Dataset Modal -->
<div class="modal" id="create-dataset-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Create New Dataset</h3>
            <button class="close-btn" onclick="hideCreateDatasetModal()">&times;</button>
        </div>
        <form id="create-dataset-form">
            <div class="form-group">
                <label class="form-label" for="dataset-name">Dataset Name</label>
                <input type="text" id="dataset-name" class="form-input" placeholder="Enter dataset name" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="dataset-description">Description (Optional)</label>
                <textarea id="dataset-description" class="form-input" rows="3" placeholder="Describe this dataset"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Select Documents</label>
                <div class="checkbox-group" id="document-selection">
                    <!-- Document checkboxes will be loaded here -->
                </div>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="hideCreateDatasetModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Dataset</button>
            </div>
        </form>
    </div>
</div>

<!-- Upload Documents Modal -->
<div class="modal" id="upload-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Upload Documents</h3>
            <button class="close-btn" onclick="hideUploadModal()">&times;</button>
        </div>
        <div id="upload-area" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 40px; text-align: center; margin-bottom: 20px;">
            <div style="font-size: 2rem; margin-bottom: 16px; opacity: 0.5;">📁</div>
            <p>Drag and drop files here or <button type="button" class="btn btn-primary" onclick="document.getElementById('file-input').click()">browse files</button></p>
            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 8px;">Supported formats: PDF, TXT, DOCX, JSON</p>
            <input type="file" id="file-input" multiple accept=".pdf,.txt,.docx,.json" style="display: none;">
        </div>
        <div id="upload-progress" style="display: none;">
            <div style="background: #f3f4f6; border-radius: 8px; padding: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Uploading...</span>
                    <span id="upload-percentage">0%</span>
                </div>
                <div style="background: #e5e7eb; border-radius: 4px; height: 8px;">
                    <div id="upload-bar" style="background: #3b82f6; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="hideUploadModal()">Close</button>
        </div>
    </div>
</div>

<!-- Create Training Job Modal -->
<div class="modal" id="create-training-modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 class="modal-title">Create Training Job</h3>
            <button class="close-btn" onclick="hideCreateTrainingModal()">&times;</button>
        </div>
        <form id="create-training-form">
            <div class="form-group">
                <label class="form-label" for="training-name">Job Name</label>
                <input type="text" id="training-name" class="form-input" placeholder="Enter training job name" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="training-model">Model</label>
                    <input type="text" id="training-model" class="form-control" list="model-options" 
                           placeholder="Type or select a model..." required>
                    <datalist id="model-options">
                    </datalist>
                    <small class="form-text text-muted">You can select from available models or type a custom model name</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="training-dataset">Dataset</label>
                    <select id="training-dataset" class="form-select" required>
                        <option value="">Select a dataset...</option>
                    </select>
                </div>
            </div>

            <div class="config-section">
                <div class="config-title">Training Configuration</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="config-epochs">Epochs</label>
                        <input type="number" id="config-epochs" class="form-input" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="config-batch-size">Batch Size</label>
                        <input type="number" id="config-batch-size" class="form-input" value="8" min="1" max="64">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="config-learning-rate">Learning Rate</label>
                        <input type="number" id="config-learning-rate" class="form-input" value="0.0001" step="0.0001" min="0.00001" max="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="config-max-length">Max Length</label>
                        <input type="number" id="config-max-length" class="form-input" value="512" min="128" max="2048">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="hideCreateTrainingModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create & Start Training</button>
            </div>
        </form>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal" id="generate-report-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Generate Training Report</h3>
            <button class="close-btn" onclick="hideGenerateReportModal()">&times;</button>
        </div>
        <form id="generate-report-form">
            <div class="form-group">
                <label class="form-label">Select Training Jobs</label>
                <div class="checkbox-group" id="job-selection">
                    <!-- Training job checkboxes will be loaded here -->
                </div>
            </div>
            
            <div class="config-section">
                <div class="config-title">Report Options</div>
                <div class="checkbox-item">
                    <input type="checkbox" id="include-metrics" checked>
                    <label for="include-metrics">Include Training Metrics</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="include-logs">
                    <label for="include-logs">Include Training Logs</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="include-model-info" checked>
                    <label for="include-model-info">Include Model Information</label>
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label" for="report-format">Format</label>
                    <select id="report-format" class="form-select">
                        <option value="html">HTML</option>
                        <option value="pdf">PDF</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="hideGenerateReportModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Generate Report</button>
            </div>
        </form>
    </div>
</div>

<!-- Job Details Modal -->
<div class="modal" id="job-details-modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 class="modal-title" id="job-details-title">Training Job Details</h3>
            <button class="close-btn" onclick="hideJobDetailsModal()">&times;</button>
        </div>
        <div id="job-details-content">
            <!-- Job details will be loaded here -->
        </div>
    </div>
</div>

<!-- Dataset Manager Modal -->
<div class="modal" id="dataset-manager-modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 class="modal-title">Manage Datasets</h3>
            <button class="close-btn" onclick="hideDatasetManagerModal()">&times;</button>
        </div>
        <div id="dataset-manager-content">
            <div class="empty-state" id="dataset-manager-empty-state">
                <div class="empty-state-icon">📊</div>
                <h3>No datasets found</h3>
                <p>Create your first dataset to organize your documents.</p>
                <button class="btn btn-primary" onclick="hideDatasetManagerModal(); showCreateDatasetModal();">
                    <i class="fas fa-plus"></i> Create Dataset
                </button>
            </div>
            <div id="dataset-list">
                <!-- Dataset list will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/llm-training.js') }}"></script>
{% endblock %}
