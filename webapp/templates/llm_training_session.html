{% extends \"layout.html\" %}

{% block content %}
<div class=\"max-w-7xl mx-auto\">
  <!-- Page Header -->
  <div class=\"mb-8\">
    <div class=\"flex items-center justify-between\">
      <div>
        <nav class=\"flex\" aria-label=\"Breadcrumb\">
          <ol class=\"flex items-center space-x-4\">
            <li>
              <div>
                <a
                  href=\"{{ url_for('llm_training.index') }}\"
                  class=\"text-gray-400 hover:text-gray-500\"
                >
                  <svg
                    class=\"flex-shrink-0 h-5 w-5\"
                    fill=\"currentColor\"
                    viewBox=\"0 0 20 20\"
                  >
                    <path
                      d=\"M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z\"
                    />
                  </svg>
                  <span class=\"sr-only\">LLM Training</span>
                </a>
              </div>
            </li>
            <li>
              <div class=\"flex items-center\">
                <svg
                  class=\"flex-shrink-0 h-5 w-5 text-gray-300\"
                  fill=\"currentColor\"
                  viewBox=\"0 0 20 20\"
                >
                  <path
                    fill-rule=\"evenodd\"
                    d=\"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z\"
                    clip-rule=\"evenodd\"
                  />
                </svg>
                <span class=\"ml-4 text-sm font-medium text-gray-500\">{{ session.name }}</span>
              </div>
            </li>
          </ol>
        </nav>
        <h1 class=\"mt-2 text-2xl font-bold text-gray-900\">
          Training Session: {{ session.name }}
        </h1>
        <p class=\"mt-2 text-sm text-gray-600\">
          {{ session.description or 'No description provided' }}
        </p>
      </div>
      <div class=\"flex space-x-3\">
        <button
          type=\"button\"
          id=\"test-model-btn\"
          class=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"
        >
          <svg
            class=\"mr-2 h-4 w-4\"
            fill=\"none\"
            stroke=\"currentColor\"
            viewBox=\"0 0 24 24\"
          >
            <path
              stroke-linecap=\"round\"
              stroke-linejoin=\"round\"
              stroke-width=\"2\"
              d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\"
            />
          </svg>
          Test Model
        </button>
        <a
          href=\"{{ url_for('llm_training.index') }}\"
          class=\"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"
        >
          <svg
            class=\"mr-2 h-4 w-4\"
            fill=\"none\"
            stroke=\"currentColor\"
            viewBox=\"0 0 24 24\"
          >
            <path
              stroke-linecap=\"round\"
              stroke-linejoin=\"round\"
              stroke-width=\"2\"
              d=\"M10 19l-7-7m0 0l7-7m-7 7h18\"
            />
          </svg>
          Back to Training
        </a>
      </div>
    </div>
  </div>

  <!-- Session Info Cards -->
  <div class=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\">
    <div class=\"bg-white overflow-hidden shadow rounded-lg\">
      <div class=\"p-5 text-center\">
        <div
          class=\"w-12 h-12 bg-primary-500 rounded-lg flex items-center justify-center mx-auto mb-3\"
        >
          <svg
            class=\"w-6 h-6 text-white\"
            fill=\"none\"
            stroke=\"currentColor\"
            viewBox=\"0 0 24 24\"
          >
            <path
              stroke-linecap=\"round\"
              stroke-linejoin=\"round\"
              stroke-width=\"2\"
              d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"
            />
          </svg>
        </div>
        <dl>
          <dt class=\"text-sm font-medium text-gray-500 mb-1\">Session Name</dt>
          <dd class=\"text-lg font-medium text-gray-900\">{{ session.name }}</dd>
        </dl>
      </div>
    </div>

    <div class=\"bg-white overflow-hidden shadow rounded-lg\">
      <div class=\"p-5 text-center\">
        <div
          class=\"w-12 h-12 bg-info-500 rounded-lg flex items-center justify-center mx-auto mb-3\"
        >
          <svg
            class=\"w-6 h-6 text-white\"
            fill=\"none\"
            stroke=\"currentColor\"
            viewBox=\"0 0 24 24\"
          >
            <path
              stroke-linecap=\"round\"
              stroke-linejoin=\"round\"
              stroke-width=\"2\"
              d=\"M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z\"
            />
          </svg>
        </div>
        <dl>
          <dt class=\"text-sm font-medium text-gray-500 mb-1\">Submissions</dt>
          <dd class=\"text-lg font-medium text-gray-900\">{{ submissions|length }}</dd>
        </dl>
      </div>
    </div>

    <div class=\"bg-white overflow-hidden shadow rounded-lg\">
      <div class=\"p-5 text-center\">
        <div
          class=\"w-12 h-12 bg-success-500 rounded-lg flex items-center justify-center mx-auto mb-3\"
        >
          <svg
            class=\"w-6 h-6 text-white\"
            fill=\"none\"
            stroke=\"currentColor\"
            viewBox=\"0 0 24 24\"
          >
            <path
              stroke-linecap=\"round\"
              stroke-linejoin=\"round\"
              stroke-width=\"2\"
              d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"
            />
          </svg>
        </div>
        <dl>
          <dt class=\"text-sm font-medium text-gray-500 mb-1\">Status</dt>
          <dd class=\"text-lg font-medium text-gray-900\">
            <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success-100 text-success-800\">
              {{ session.status|title }}
            </span>
          </dd>
        </dl>
      </div>
    </div>

    <div class=\"bg-white overflow-hidden shadow rounded-lg\">
      <div class=\"p-5 text-center\">
        <div
          class=\"w-12 h-12 bg-warning-500 rounded-lg flex items-center justify-center mx-auto mb-3\"
        >
          <svg
            class=\"w-6 h-6 text-white\"
            fill=\"none\"
            stroke=\"currentColor\"
            viewBox=\"0 0 24 24\"
          >
            <path
              stroke-linecap=\"round\"
              stroke-linejoin=\"round\"
              stroke-width=\"2\"
              d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"
            />
          </svg>
        </div>
        <dl>
          <dt class=\"text-sm font-medium text-gray-500 mb-1\">Created</dt>
          <dd class=\"text-lg font-medium text-gray-900\">
            {{ session.created_at.strftime(\"%Y-%m-%d\") if session.created_at else 'Unknown' }}
          </dd>
        </dl>
      </div>
    </div>
  </div>

  <!-- Model Testing Section -->
  <div class=\"bg-white shadow rounded-lg\">
    <div class=\"px-6 py-4 border-b border-gray-200\">
      <h3 class=\"text-lg leading-6 font-medium text-gray-900\">
        Model Testing
      </h3>
      <p class=\"mt-1 text-sm text-gray-500\">
        Test the trained model with sample data.
      </p>
    </div>
    
    <div class=\"p-6\">
      <div class=\"mb-4\">
        <label for=\"test-data\" class=\"block text-sm font-medium text-gray-700 mb-2\">
          Test Input
        </label>
        <textarea
          id=\"test-data\"
          rows=\"4\"
          class=\"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500\"
          placeholder=\"Enter test data here...\"
        ></textarea>
      </div>
      
      <div class=\"flex justify-between items-center mb-4\">
        <button
          type=\"button\"
          id=\"run-test-btn\"
          class=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"
        >
          <svg
            class=\"mr-2 h-4 w-4\"
            fill=\"none\"
            stroke=\"currentColor\"
            viewBox=\"0 0 24 24\"
          >
            <path
              stroke-linecap=\"round\"
              stroke-linejoin=\"round\"
              stroke-width=\"2\"
              d=\"M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m6-10V7a3 3 0 11-6 0V4a3 3 0 116 0v3M5 12a9 9 0 1118 0 9 9 0 01-18 0z\"
            />
          </svg>
          Run Test
        </button>
        
        <div id=\"loading-indicator\" class=\"hidden\">
          <div class=\"flex items-center\">
            <svg class=\"animate-spin -ml-1 mr-3 h-5 w-5 text-primary-600\" fill=\"none\" viewBox=\"0 0 24 24\">
              <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>
              <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>
            </svg>
            <span class=\"text-sm text-gray-600\">Testing model...</span>
          </div>
        </div>
      </div>
      
      <div id=\"test-results\" class=\"hidden\">
        <!-- Test results will be displayed here -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener(\"DOMContentLoaded\", function () {
    // Test model functionality
    const runTestBtn = document.getElementById('run-test-btn');
    const testDataInput = document.getElementById('test-data');
    const loadingIndicator = document.getElementById('loading-indicator');
    const testResults = document.getElementById('test-results');
    
    if (runTestBtn) {
      runTestBtn.addEventListener('click', function() {
        const testData = testDataInput.value.trim();
        
        if (!testData) {
          if (typeof ExamGrader !== 'undefined' && ExamGrader.notificationManager) {
            ExamGrader.notificationManager.notify('Please enter test data', 'error');
          } else {
            alert('Please enter test data');
          }
          return;
        }
        
        // Show loading
        runTestBtn.disabled = true;
        loadingIndicator.classList.remove('hidden');
        testResults.classList.add('hidden');
        
        // Make API call
        fetch('/llm-training/api/test-model', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
          },
          body: JSON.stringify({
            session_id: '{{ session.id }}',
            test_data: testData
          })
        })
        .then(response => response.json())
        .then(data => {
          runTestBtn.disabled = false;
          loadingIndicator.classList.add('hidden');
          
          if (data.success) {
            displayTestResults(data.result);
            if (typeof ExamGrader !== 'undefined' && ExamGrader.notificationManager) {
              ExamGrader.notificationManager.notify('Model test completed', 'success');
            }
          } else {
            if (typeof ExamGrader !== 'undefined' && ExamGrader.notificationManager) {
              ExamGrader.notificationManager.notify(data.error || 'Test failed', 'error');
            } else {
              alert(data.error || 'Test failed');
            }
          }
        })
        .catch(error => {
          runTestBtn.disabled = false;
          loadingIndicator.classList.add('hidden');
          console.error('Test error:', error);
          if (typeof ExamGrader !== 'undefined' && ExamGrader.notificationManager) {
            ExamGrader.notificationManager.notify('Test failed: ' + error.message, 'error');
          } else {
            alert('Test failed: ' + error.message);
          }
        });
      });
    }
    
    function displayTestResults(result) {
      testResults.innerHTML = `
        <div class=\"bg-gray-50 rounded-lg p-4\">
          <h4 class=\"text-lg font-medium text-gray-900 mb-4\">Test Results</h4>
          <div class=\"grid grid-cols-2 gap-4\">
            <div>
              <span class=\"text-sm font-medium text-gray-500\">Accuracy:</span>
              <span class=\"ml-2 text-lg font-semibold text-gray-900\">${(result.accuracy * 100).toFixed(1)}%</span>
            </div>
            <div>
              <span class=\"text-sm font-medium text-gray-500\">Confidence:</span>
              <span class=\"ml-2 text-lg font-semibold text-gray-900\">${(result.confidence * 100).toFixed(1)}%</span>
            </div>
            <div>
              <span class=\"text-sm font-medium text-gray-500\">Processing Time:</span>
              <span class=\"ml-2 text-lg font-semibold text-gray-900\">${result.processing_time}ms</span>
            </div>
            <div>
              <span class=\"text-sm font-medium text-gray-500\">Model Version:</span>
              <span class=\"ml-2 text-lg font-semibold text-gray-900\">${result.model_version}</span>
            </div>
          </div>
          ${result.output ? `
            <div class=\"mt-4\">
              <span class=\"text-sm font-medium text-gray-500\">Model Output:</span>
              <div class=\"mt-2 p-3 bg-white rounded border\">
                <pre class=\"text-sm text-gray-800 whitespace-pre-wrap\">${result.output}</pre>
              </div>
            </div>
          ` : ''}
        </div>
      `;
      testResults.classList.remove('hidden');
    }
  });
</script>
{% endblock %}