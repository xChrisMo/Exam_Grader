<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-healthy { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-critical { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        
        .metric-card {
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .alert-item {
            border-left: 4px solid;
        }
        
        .alert-critical { border-left-color: #dc3545; }
        .alert-warning { border-left-color: #ffc107; }
        .alert-info { border-left-color: #17a2b8; }
        
        .refresh-indicator {
            display: none;
        }
        
        .refresh-indicator.active {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-tachometer-alt"></i> System Monitoring Dashboard</h1>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt refresh-indicator" id="refreshIcon"></i>
                            Refresh
                        </button>
                        <span class="badge bg-secondary ms-2" id="lastUpdate">Never</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h2 class="mb-3">System Status</h2>
                        <div class="d-flex justify-content-center align-items-center">
                            <i class="fas fa-circle fa-3x me-3" id="overallStatusIcon"></i>
                            <div>
                                <h3 id="overallStatusText" class="mb-0">Loading...</h3>
                                <small class="text-muted" id="overallStatusTime"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-microchip fa-2x mb-2 text-primary"></i>
                        <h5>CPU Usage</h5>
                        <h3 id="cpuUsage">--%</h3>
                        <div class="progress mt-2">
                            <div class="progress-bar" id="cpuProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-memory fa-2x mb-2 text-success"></i>
                        <h5>Memory Usage</h5>
                        <h3 id="memoryUsage">--%</h3>
                        <div class="progress mt-2">
                            <div class="progress-bar bg-success" id="memoryProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-hdd fa-2x mb-2 text-warning"></i>
                        <h5>Disk Usage</h5>
                        <h3 id="diskUsage">--%</h3>
                        <div class="progress mt-2">
                            <div class="progress-bar bg-warning" id="diskProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-database fa-2x mb-2 text-info"></i>
                        <h5>DB Response</h5>
                        <h3 id="dbResponse">--ms</h3>
                        <small class="text-muted" id="dbStatus">Checking...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Health Checks -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat"></i> Service Health</h5>
                    </div>
                    <div class="card-body">
                        <div id="healthChecks">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Active Alerts</h5>
                    </div>
                    <div class="card-body">
                        <div id="activeAlerts">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> CPU & Memory Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="systemMetricsChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Training Statistics</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trainingStatsChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let systemMetricsChart;
        let trainingStatsChart;
        let refreshInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            refreshData();
            
            // Auto-refresh every 30 seconds
            refreshInterval = setInterval(refreshData, 30000);
        });

        function initializeCharts() {
            // System Metrics Chart
            const ctx1 = document.getElementById('systemMetricsChart').getContext('2d');
            systemMetricsChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Memory Usage (%)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Training Statistics Chart
            const ctx2 = document.getElementById('trainingStatsChart').getContext('2d');
            trainingStatsChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Active', 'Failed'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('active');

            try {
                // Get system status
                const statusResponse = await fetch('/api/monitoring/health');
                const statusData = await statusResponse.json();

                if (statusData.success) {
                    updateSystemStatus(statusData.data);
                    updateMetrics(statusData.data.metrics);
                    updateHealthChecks(statusData.data.health_checks);
                }

                // Get alerts
                const alertsResponse = await fetch('/api/monitoring/alerts');
                const alertsData = await alertsResponse.json();

                if (alertsData.success) {
                    updateAlerts(alertsData.data.alerts);
                }

                // Get dashboard data for charts
                const dashboardResponse = await fetch('/api/monitoring/dashboard');
                const dashboardData = await dashboardResponse.json();

                if (dashboardData.success) {
                    updateCharts(dashboardData.data);
                }

                // Update last refresh time
                document.getElementById('lastUpdate').textContent = 
                    new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Failed to refresh monitoring data');
            } finally {
                refreshIcon.classList.remove('active');
            }
        }

        function updateSystemStatus(data) {
            const statusIcon = document.getElementById('overallStatusIcon');
            const statusText = document.getElementById('overallStatusText');
            const statusTime = document.getElementById('overallStatusTime');

            statusText.textContent = data.overall_status.toUpperCase();
            statusTime.textContent = `Last checked: ${new Date(data.timestamp).toLocaleTimeString()}`;

            // Update icon and color based on status
            statusIcon.className = 'fas fa-circle fa-3x me-3';
            statusText.className = 'mb-0';

            switch (data.overall_status) {
                case 'healthy':
                    statusIcon.classList.add('status-healthy');
                    statusText.classList.add('status-healthy');
                    break;
                case 'warning':
                    statusIcon.classList.add('status-warning');
                    statusText.classList.add('status-warning');
                    break;
                case 'critical':
                    statusIcon.classList.add('status-critical');
                    statusText.classList.add('status-critical');
                    break;
                default:
                    statusIcon.classList.add('status-unknown');
                    statusText.classList.add('status-unknown');
            }
        }

        function updateMetrics(metrics) {
            // CPU Usage
            document.getElementById('cpuUsage').textContent = `${metrics.cpu_usage.toFixed(1)}%`;
            document.getElementById('cpuProgress').style.width = `${metrics.cpu_usage}%`;
            updateProgressBarColor('cpuProgress', metrics.cpu_usage);

            // Memory Usage
            document.getElementById('memoryUsage').textContent = `${metrics.memory_usage.toFixed(1)}%`;
            document.getElementById('memoryProgress').style.width = `${metrics.memory_usage}%`;
            updateProgressBarColor('memoryProgress', metrics.memory_usage);

            // Disk Usage
            document.getElementById('diskUsage').textContent = `${metrics.disk_usage.toFixed(1)}%`;
            document.getElementById('diskProgress').style.width = `${metrics.disk_usage}%`;
            updateProgressBarColor('diskProgress', metrics.disk_usage);

            // Database Response
            document.getElementById('dbResponse').textContent = `${metrics.response_time_ms.toFixed(0)}ms`;
            const dbStatus = document.getElementById('dbStatus');
            if (metrics.response_time_ms < 1000) {
                dbStatus.textContent = 'Excellent';
                dbStatus.className = 'text-success';
            } else if (metrics.response_time_ms < 5000) {
                dbStatus.textContent = 'Good';
                dbStatus.className = 'text-warning';
            } else {
                dbStatus.textContent = 'Slow';
                dbStatus.className = 'text-danger';
            }
        }

        function updateProgressBarColor(elementId, value) {
            const element = document.getElementById(elementId);
            element.className = 'progress-bar';
            
            if (value < 70) {
                element.classList.add('bg-success');
            } else if (value < 85) {
                element.classList.add('bg-warning');
            } else {
                element.classList.add('bg-danger');
            }
        }

        function updateHealthChecks(healthChecks) {
            const container = document.getElementById('healthChecks');
            let html = '';

            for (const [service, check] of Object.entries(healthChecks)) {
                const statusClass = `status-${check.status}`;
                const icon = getStatusIcon(check.status);
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <i class="fas ${icon} ${statusClass} me-2"></i>
                            <strong>${service.charAt(0).toUpperCase() + service.slice(1)}</strong>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark">${check.response_time_ms.toFixed(0)}ms</span>
                        </div>
                    </div>
                    <div class="text-muted small mb-3">${check.message}</div>
                `;
            }

            container.innerHTML = html || '<div class="text-muted">No health checks available</div>';
        }

        function updateAlerts(alerts) {
            const container = document.getElementById('activeAlerts');
            let html = '';

            if (alerts.length === 0) {
                html = '<div class="text-success"><i class="fas fa-check-circle"></i> No active alerts</div>';
            } else {
                alerts.slice(0, 5).forEach(alert => {
                    const alertClass = `alert-${alert.level.toLowerCase()}`;
                    const icon = getAlertIcon(alert.level);
                    const timeAgo = getTimeAgo(new Date(alert.timestamp));
                    
                    html += `
                        <div class="alert-item p-2 mb-2 ${alertClass}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <i class="fas ${icon} me-2"></i>
                                    <strong>${alert.service}</strong>
                                </div>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            <div class="small mt-1">${alert.message}</div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function updateCharts(dashboardData) {
            // Update training statistics chart
            if (dashboardData.training_statistics) {
                const stats = dashboardData.training_statistics;
                trainingStatsChart.data.datasets[0].data = [
                    stats.completed_jobs || 0,
                    stats.active_jobs || 0,
                    stats.failed_jobs || 0
                ];
                trainingStatsChart.update();
            }

            // Update system metrics chart with historical data
            if (dashboardData.historical_metrics && dashboardData.historical_metrics.length > 0) {
                const metrics = dashboardData.historical_metrics.slice(-20); // Last 20 points
                
                systemMetricsChart.data.labels = metrics.map(m => 
                    new Date(m.timestamp).toLocaleTimeString()
                );
                systemMetricsChart.data.datasets[0].data = metrics.map(m => m.cpu_usage);
                systemMetricsChart.data.datasets[1].data = metrics.map(m => m.memory_usage);
                systemMetricsChart.update();
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'healthy': return 'fa-check-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'critical': return 'fa-times-circle';
                default: return 'fa-question-circle';
            }
        }

        function getAlertIcon(level) {
            switch (level.toLowerCase()) {
                case 'critical': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-bell';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        function showError(message) {
            // Simple error display - could be enhanced with toast notifications
            console.error(message);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>