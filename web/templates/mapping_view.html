{% extends "base.html" %}

{% block title %}Criteria Mapping - Exam Grader{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 mb-3">Criteria Mapping</h1>
            
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            Criteria-to-Submission Mapping
                        </h5>
                        <div>
                            <a href="{{ url_for('view_submission') }}" class="btn btn-sm btn-outline-light me-2">
                                <i class="bi bi-file-text"></i> View Submission
                            </a>
                            <a href="{{ url_for('view_guide') }}" class="btn btn-sm btn-outline-light">
                                <i class="bi bi-journal-check"></i> View Guide
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i>
                        This view shows how sections of the student submission map to the criteria in the marking guide.
                        Each mapping shows the criterion from the guide and the corresponding section from the student submission.
                    </div>
                    
                    <!-- Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card border-info h-100">
                                <div class="card-body text-center">
                                    <h3 class="display-4 text-info">{{ mapping_result.metadata.mapping_count }}</h3>
                                    <p class="text-muted">Criteria Mapped</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <h3 class="display-4 text-warning">{{ mapping_result.unmapped_guide_sections|length }}</h3>
                                    <p class="text-muted">Unmapped Criteria</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-danger h-100">
                                <div class="card-body text-center">
                                    <h3 class="display-4 text-danger">{{ mapping_result.unmapped_submission_sections|length }}</h3>
                                    <p class="text-muted">Unmapped Submission Sections</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mappings -->
                    <h4 class="mb-3 border-bottom pb-2"><i class="bi bi-link-45deg"></i> Criteria Mappings</h4>
                    
                    {% if mapping_result.criteria_mappings %}
                        <div class="accordion" id="criteriaAccordion">
                            {% for mapping in mapping_result.criteria_mappings %}
                                <div class="accordion-item mb-3 border">
                                    <h2 class="accordion-header" id="heading{{ mapping.criterion_id }}">
                                        <button class="accordion-button {% if loop.index > 3 %}collapsed{% endif %}" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapse{{ mapping.criterion_id }}" 
                                                aria-expanded="{% if loop.index <= 3 %}true{% else %}false{% endif %}" 
                                                aria-controls="collapse{{ mapping.criterion_id }}">
                                            <div class="d-flex w-100 justify-content-between align-items-center">
                                                <div>
                                                    <span class="badge bg-primary me-2">Criterion {{ mapping.criterion_id }}</span>
                                                    {{ mapping.criterion_text|truncate(100) }}
                                                </div>
                                                <span class="badge {% if mapping.confidence >= 0.8 %}bg-success{% elif mapping.confidence >= 0.5 %}bg-warning{% else %}bg-danger{% endif %} ms-2">
                                                    {{ (mapping.confidence * 100)|round|int }}% Match
                                                </span>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapse{{ mapping.criterion_id }}" class="accordion-collapse collapse {% if loop.index <= 3 %}show{% endif %}" 
                                         aria-labelledby="heading{{ mapping.criterion_id }}" data-bs-parent="#criteriaAccordion">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="card h-100">
                                                        <div class="card-header bg-light">
                                                            <h5 class="card-title mb-0 fs-6">Criterion</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <p class="card-text criterion-text">{{ mapping.criterion_text }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card h-100">
                                                        <div class="card-header bg-light">
                                                            <h5 class="card-title mb-0 fs-6">Student Submission</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <p class="card-text submission-text">{{ mapping.mapped_text }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% if mapping.comments %}
                                                <div class="mt-3 p-3 bg-light rounded">
                                                    <strong>AI Comments:</strong> {{ mapping.comments }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            No criteria mappings found. The AI was unable to map the submission to the marking guide criteria.
                        </div>
                    {% endif %}
                    
                    <!-- Unmapped Sections -->
                    <div class="row mt-5">
                        <div class="col-md-6">
                            <h4 class="mb-3 border-bottom pb-2"><i class="bi bi-list-ul"></i> Unmapped Criteria</h4>
                            <div class="card">
                                <div class="card-body">
                                    {% if mapping_result.unmapped_guide_sections %}
                                        <ul class="list-group">
                                            {% for section in mapping_result.unmapped_guide_sections %}
                                                <li class="list-group-item">{{ section }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-success">
                                            <i class="bi bi-check-circle-fill"></i>
                                            All criteria in the marking guide were addressed in the submission!
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 class="mb-3 border-bottom pb-2"><i class="bi bi-list-ul"></i> Unmapped Submission Sections</h4>
                            <div class="card">
                                <div class="card-body">
                                    {% if mapping_result.unmapped_submission_sections %}
                                        <ul class="list-group">
                                            {% for section in mapping_result.unmapped_submission_sections %}
                                                <li class="list-group-item">{{ section }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-success">
                                            <i class="bi bi-check-circle-fill"></i>
                                            All sections of the submission were mapped to criteria!
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        <a href="{{ url_for('grade_submission') }}" class="btn btn-success me-2">
                            <i class="bi bi-stars"></i> Grade Submission
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .criterion-text, .submission-text {
        white-space: pre-wrap;
        max-height: 250px;
        overflow-y: auto;
    }
</style>
{% endblock %} 